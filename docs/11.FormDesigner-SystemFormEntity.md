# 11. FormDesigner y SystemFormEntity - Sistema Din√°mico de Entidades

Esta gu√≠a explica el sistema **FormDesigner** implementado que permite gestionar din√°micamente las entidades disponibles para dise√±o de formularios mediante la tabla `system_form_entities`.

## üéØ Visi√≥n General

El FormDesigner es un sistema que:
- **Gestiona entidades din√°micamente** desde base de datos (no hardcodeado)
- **Organiza entidades por categor√≠as** e iconos Material Design
- **Soporta entidades globales y espec√≠ficas** por organizaci√≥n
- **Se integra autom√°ticamente** con el entity-generator.py

## üìä Estructura de SystemFormEntity

### Tabla: system_form_entities

```sql
CREATE TABLE system_form_entities (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    OrganizationId UNIQUEIDENTIFIER NULL,           -- NULL = Global, GUID = Espec√≠fica
    FechaCreacion DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    FechaModificacion DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    CreadorId UNIQUEIDENTIFIER NOT NULL,
    ModificadorId UNIQUEIDENTIFIER NOT NULL,
    Active BIT NOT NULL DEFAULT 1,

    -- Campos espec√≠ficos de FormDesigner
    EntityName NVARCHAR(100) NOT NULL,              -- Nombre t√©cnico (ej: "Empleado")
    DisplayName NVARCHAR(200) NOT NULL,             -- Nombre amigable (ej: "Empleados")
    Description NVARCHAR(500) NULL,                 -- Descripci√≥n de la entidad
    TableName NVARCHAR(100) NOT NULL,               -- Nombre de tabla (ej: "empleados")
    IconName NVARCHAR(50) NULL,                     -- Icono Material Design
    Category NVARCHAR(100) NULL,                    -- Categor√≠a (ej: "RRHH", "Core")
    AllowCustomFields BIT NOT NULL DEFAULT 1,       -- Permite campos personalizados
    SortOrder INT NOT NULL DEFAULT 100              -- Orden de presentaci√≥n
);
```

### Modelo C#: SystemFormEntity

```csharp
[Table("system_form_entities")]
public class SystemFormEntity : BaseEntity
{
    [Required]
    [MaxLength(100)]
    public string EntityName { get; set; } = "";

    [Required]
    [MaxLength(200)]
    public string DisplayName { get; set; } = "";

    [MaxLength(500)]
    public string? Description { get; set; }

    [Required]
    [MaxLength(100)]
    public string TableName { get; set; } = "";

    public bool AllowCustomFields { get; set; } = true;

    [MaxLength(50)]
    public string? IconName { get; set; }

    [MaxLength(100)]
    public string? Category { get; set; }

    public int SortOrder { get; set; } = 100;
}
```

## üîß FormDesignerController - Implementaci√≥n

### Endpoints Disponibles

#### 1. GET /api/FormDesigner/entities
Obtiene entidades disponibles para FormDesigner.

```csharp
[HttpGet("entities")]
public async Task<IActionResult> GetAvailableEntities()
{
    try
    {
        var organizationId = GetCurrentOrganizationId();

        // Obtener entidades globales (OrganizationId=NULL) y espec√≠ficas
        var entities = await _context.SystemFormEntities
            .Where(e => e.Active && (e.OrganizationId == null || e.OrganizationId == organizationId))
            .OrderBy(e => e.SortOrder)
            .Select(e => new FormEntityDto
            {
                Id = e.Id,
                EntityName = e.EntityName,
                DisplayName = e.DisplayName,
                Description = e.Description,
                IconName = e.IconName,
                Category = e.Category,
                AllowCustomFields = e.AllowCustomFields,
                IsActive = e.Active
            })
            .ToListAsync();

        return Ok(new { success = true, data = entities });
    }
    catch (Exception ex)
    {
        return BadRequest(new { success = false, message = ex.Message });
    }
}
```

#### 2. POST /api/FormDesigner/available-fields
Obtiene campos disponibles para una entidad espec√≠fica.

#### 3. GET /api/FormDesigner/layout/{entityName}
Obtiene layout de formulario para una entidad.

#### 4. POST /api/FormDesigner/save-layout
Guarda configuraci√≥n de layout de formulario.

## üöÄ Integraci√≥n con Entity-Generator

### Par√°metros del Entity-Generator

El entity-generator.py ahora soporta auto-registro en system_form_entities:

```bash
python3 tools/forms/entity-generator.py \
  --entity "NombreEntidad" \
  --module "Modulo.Core" \
  --target todo \
  --auto-register \              # Auto-registrar en system_form_entities
  --system-entity \              # Marcar como entidad global (OrganizationId=NULL)
  --icon "material_icon" \       # Icono Material Design
  --category "Categoria" \       # Categor√≠a de organizaci√≥n
  --allow-custom-fields \        # Permitir campos personalizados
  --fields "nombre:string:100"
```

### Proceso de Auto-Registro

Cuando se usa `--target todo --auto-register`, el generador:

1. **Crea la entidad completa** (tabla + backend + frontend)
2. **Ejecuta SQL de registro** en system_form_entities:

```sql
INSERT INTO system_form_entities (
    Id, OrganizationId, FechaCreacion, FechaModificacion,
    CreadorId, ModificadorId, Active,
    EntityName, DisplayName, Description, TableName,
    IconName, Category, AllowCustomFields, SortOrder
) VALUES (
    NEWID(), NULL, GETUTCDATE(), GETUTCDATE(),
    '00000000-0000-0000-0000-000000000000', '00000000-0000-0000-0000-000000000000', 1,
    'NombreEntidad', 'NombresEntidades', 'Gesti√≥n de nombreentidades',
    'nombreentidades', 'material_icon', 'Categoria', 1, 999
);
```

3. **La entidad aparece autom√°ticamente** en FormDesigner

## üìã Estrategia de Organizaciones

### Entidades Globales del Sistema
- **OrganizationId = NULL**
- Disponibles para **todas las organizaciones**
- Ejemplos: Empleado, Empresa, Cliente, Proveedor
- Se crean con `--system-entity`

### Entidades Espec√≠ficas por Organizaci√≥n
- **OrganizationId = GUID espec√≠fico**
- Disponibles solo para **una organizaci√≥n**
- Ejemplos: entidades customizadas por empresa
- Se crean sin `--system-entity`

### Filtrado en FormDesigner

```csharp
// El FormDesigner filtra correctamente:
var entities = await _context.SystemFormEntities
    .Where(e => e.Active && (
        e.OrganizationId == null ||                    // Entidades globales
        e.OrganizationId == currentOrganizationId      // Entidades espec√≠ficas
    ))
    .OrderBy(e => e.SortOrder)
    .ToListAsync();
```

## üé® Categor√≠as e Iconos

### Categor√≠as Est√°ndar

| Categor√≠a | Descripci√≥n | Ejemplos |
|-----------|-------------|----------|
| **Core** | Entidades centrales | Empresa, Sistema |
| **RRHH** | Recursos Humanos | Empleado, Cargo, Areas |
| **Localidades** | Geograf√≠a | Region, Comuna, Ciudad |
| **Bancario** | Financiero | Banco, TipoCuenta, FormaPago |
| **Previsional** | Previsi√≥n Social | AFP, Salud, Seguro |
| **Organizacional** | Estructura | CentroCosto, TipoContrato |

### Iconos Material Design Comunes

| Prop√≥sito | Icon | Uso |
|-----------|------|-----|
| **Personas** | `person`, `group` | Empleados, Usuarios |
| **Empresas** | `business`, `domain` | Empresas, Areas |
| **Ubicaci√≥n** | `map`, `location_city`, `apartment` | Regiones, Comunas |
| **Finanzas** | `account_balance`, `payment`, `savings` | Bancos, Pagos |
| **Trabajo** | `work`, `assignment`, `schedule` | Cargos, Contratos |
| **Seguridad** | `security`, `shield`, `health_and_safety` | Seguros, Salud |

## üõ†Ô∏è Ejemplos de Uso

### 1. Crear Entidad Global del Sistema

```bash
# Entidad global para todas las organizaciones
python3 tools/forms/entity-generator.py \
  --entity "TipoDocumento" --plural "TiposDocumento" \
  --module "Core.General" --target todo \
  --auto-register --system-entity \
  --icon "description" --category "Core" \
  --fields "nombre:string:100" "codigo:string:50"
```

**Resultado:**
- ‚úÖ Tabla `tipos_documento` creada
- ‚úÖ Backend + Frontend generados
- ‚úÖ Registrada en `system_form_entities` con `OrganizationId=NULL`
- ‚úÖ Disponible en FormDesigner para todas las organizaciones

### 2. Crear Entidad Espec√≠fica de Organizaci√≥n

```bash
# Entidad espec√≠fica para una organizaci√≥n
python3 tools/forms/entity-generator.py \
  --entity "ProductoCustom" --plural "ProductosCustom" \
  --module "Custom.Inventario" --target todo \
  --auto-register \
  --icon "inventory" --category "Custom" \
  --fields "nombre:string:100" "precio:decimal:10,2"
```

**Resultado:**
- ‚úÖ Tabla `productos_custom` creada
- ‚úÖ Backend + Frontend generados
- ‚úÖ Registrada en `system_form_entities` con `OrganizationId=NULL` (por ahora)
- ‚úÖ Disponible en FormDesigner

### 3. Consultar Entidades desde FormDesigner

```javascript
// Frontend - Obtener entidades disponibles
const response = await fetch('/api/FormDesigner/entities');
const data = await response.json();

console.log(data.data); // Array de entidades con iconos y categor√≠as
```

## üìà Beneficios del Sistema

### ‚úÖ Ventajas
1. **Din√°mico**: No m√°s hardcoding de entidades
2. **Organizado**: Categor√≠as e iconos consistentes
3. **Autom√°tico**: Auto-registro desde entity-generator
4. **Escalable**: Soporte multi-organizaci√≥n
5. **Mantenible**: Un solo lugar para gestionar entidades

### üîÑ Flujo Completo

```mermaid
graph TD
    A[entity-generator.py] --> B[Crear Entidad Completa]
    B --> C[Auto-registro en system_form_entities]
    C --> D[FormDesigner consulta BD]
    D --> E[Entidades disponibles din√°micamente]
    E --> F[Usuario dise√±a formularios]
```

## üöÄ Migraci√≥n de Datos Existentes

### Seeding de Entidades Base

Las entidades del sistema base ya est√°n insertadas:

```sql
-- Entidades base del sistema (ya ejecutado)
INSERT INTO system_form_entities VALUES
    ('Empleado', 'Empleados', 'Gesti√≥n de empleados', 'empleados', 'person', 'RRHH', 1, 10),
    ('Empresa', 'Empresas', 'Gesti√≥n de empresas', 'empresas', 'business', 'Core', 1, 20),
    ('Cliente', 'Clientes', 'Gesti√≥n de clientes', 'clientes', 'person_outline', 'Ventas', 1, 30),
    ('Proveedor', 'Proveedores', 'Gesti√≥n de proveedores', 'proveedores', 'local_shipping', 'Compras', 1, 40);
```

## üéØ Pr√≥ximos Pasos

1. **Implementar resoluci√≥n real de OrganizationId** desde JWT/Claims
2. **Crear interfaz de administraci√≥n** para gestionar system_form_entities
3. **Agregar validaciones** para evitar duplicados
4. **Implementar soft-delete** para entidades
5. **Crear sistema de versionado** para layouts de formularios

Este sistema proporciona la base s√≥lida para un FormDesigner completamente din√°mico y escalable.