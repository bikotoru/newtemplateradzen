# ğŸ”’ Sistema de Permisos a Nivel de Campo

## ğŸ“– Ãndice

1. [IntroducciÃ³n](#introducciÃ³n)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
3. [GuÃ­a de Uso RÃ¡pido](#guÃ­a-de-uso-rÃ¡pido)
4. [ConfiguraciÃ³n de Campos](#configuraciÃ³n-de-campos)
5. [Tipos de Permisos](#tipos-de-permisos)
6. [Ejemplos PrÃ¡cticos](#ejemplos-prÃ¡cticos)
7. [Sistema Force Operations](#sistema-force-operations) â­
8. [Troubleshooting](#troubleshooting)
9. [Mejores PrÃ¡cticas](#mejores-prÃ¡cticas)

---

## ğŸ¯ IntroducciÃ³n

El Sistema de Permisos a Nivel de Campo permite proteger campos especÃ­ficos de las entidades con permisos granulares. EstÃ¡ diseÃ±ado para ser:

- âœ… **Granular**: Control por campo individual
- âœ… **AutomÃ¡tico**: Sin cÃ³digo adicional en controladores
- âœ… **Thread-Safe**: Seguro para sistemas multiusuario
- âœ… **Performante**: MÃ­nimo overhead en operaciones
- âœ… **Extensible**: FÃ¡cil agregar mÃ¡s campos protegidos

---

## ğŸ—ï¸ Arquitectura del Sistema

### Componentes Principales

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FieldPermission â”‚    â”‚  CurrentUser     â”‚    â”‚ EF Interceptors â”‚
â”‚   Attribute     â”‚ â”€â”€ â”‚    Service       â”‚ â”€â”€ â”‚    System       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Metadata    â”‚    â”‚   Permission     â”‚    â”‚    Query &      â”‚
â”‚    Generation   â”‚    â”‚   Validation     â”‚    â”‚  Save Handlers  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Flujo de Operaciones

1. **VIEW (Consultas)**: `NoSelectQueryInterceptor` oculta campos automÃ¡ticamente
2. **CREATE (Crear)**: `FieldPermissionSaveHandler` valida antes de insertar
3. **UPDATE (Actualizar)**: `FieldPermissionSaveHandler` valida antes de modificar

---

## ğŸš€ GuÃ­a de Uso RÃ¡pido

### **Paso 1: Agregar Atributo a Campo**
```csharp
[FieldPermission(
    CREATE = "EMPLEADO.SUELDOBASE.CREATE",
    UPDATE = "EMPLEADO.SUELDOBASE.EDIT", 
    VIEW = "EMPLEADO.SUELDOBASE.VIEW"
)]
public decimal? SueldoBase { get; set; }
```

### **Paso 2: Generar Metadata**
```bash
python tools/entities/customvalidator.py empleado:SueldoBase:FieldPermission
```

### **Paso 3: Crear Permisos en Base de Datos**
```sql
INSERT INTO SystemPermissions (Nombre, ActionKey, Grupo, Active) VALUES
('Ver Sueldo Base', 'EMPLEADO.SUELDOBASE.VIEW', 'RRHH', 1),
('Crear Sueldo Base', 'EMPLEADO.SUELDOBASE.CREATE', 'RRHH', 1),
('Editar Sueldo Base', 'EMPLEADO.SUELDOBASE.EDIT', 'RRHH', 1);
```

### **Â¡Listo!** El sistema automÃ¡ticamente:
- âŒ Oculta `SueldoBase` si no tienes permiso `VIEW`
- âŒ Bloquea creaciÃ³n si no tienes permiso `CREATE`  
- âŒ Bloquea actualizaciÃ³n si no tienes permiso `UPDATE`

---

## ğŸ”§ ConfiguraciÃ³n de Campos

### **Sintaxis del Atributo**
```csharp
[FieldPermission(
    CREATE = "ENTIDAD.CAMPO.CREATE",  // Opcional
    UPDATE = "ENTIDAD.CAMPO.EDIT",    // Opcional  
    VIEW = "ENTIDAD.CAMPO.VIEW"       // Opcional
)]
public TipoDato NombreCampo { get; set; }
```

### **UbicaciÃ³n: Metadata Files**
```csharp
// Empleado.Metadata.cs
[MetadataType(typeof(EmpleadoMetadata))]
public partial class Empleado { }

public class EmpleadoMetadata
{
    [FieldPermission(
        CREATE = "EMPLEADO.SUELDOBASE.CREATE",
        UPDATE = "EMPLEADO.SUELDOBASE.EDIT", 
        VIEW = "EMPLEADO.SUELDOBASE.VIEW"
    )]
    public string SueldoBase;
}
```

---

## ğŸ­ Tipos de Permisos

### **CREATE** - Control de CreaciÃ³n
- **CuÃ¡ndo se valida**: Al insertar nueva entidad
- **Comportamiento**: Si no tiene permiso â†’ `UnauthorizedAccessException`
- **Ejemplo**: Evitar que usuarios creen empleados con sueldo

### **UPDATE** - Control de ActualizaciÃ³n  
- **CuÃ¡ndo se valida**: Al modificar entidad existente
- **Comportamiento**: Si no tiene permiso â†’ `UnauthorizedAccessException`
- **Ejemplo**: Solo RRHH puede modificar sueldos existentes

### **VIEW** - Control de VisualizaciÃ³n
- **CuÃ¡ndo se valida**: Al consultar entidades
- **Comportamiento**: Si no tiene permiso â†’ Campo = `null`
- **Ejemplo**: Ocultar sueldos a usuarios sin autorizaciÃ³n

---

## ğŸ§ª Ejemplos PrÃ¡cticos

### **Ejemplo 1: Proteger Sueldo Base**
```csharp
// 1. En Empleado.Metadata.cs
[FieldPermission(
    CREATE = "EMPLEADO.SUELDOBASE.CREATE",
    UPDATE = "EMPLEADO.SUELDOBASE.EDIT", 
    VIEW = "EMPLEADO.SUELDOBASE.VIEW"
)]
public string SueldoBase;

// 2. Generar metadata
// python tools/entities/customvalidator.py empleado:SueldoBase:FieldPermission

// 3. Resultado automÃ¡tico:
// - GET /empleados â†’ SueldoBase = null (sin permiso VIEW)
// - POST /empleados â†’ Error 403 (sin permiso CREATE)
// - PUT /empleados â†’ Error 403 (sin permiso UPDATE)
```

### **Ejemplo 2: Solo Proteger VisualizaciÃ³n**
```csharp
[FieldPermission(VIEW = "EMPLEADO.DOCUMENTO.VIEW")]
public string NumeroDocumento;
```

### **Ejemplo 3: Solo Proteger ModificaciÃ³n**
```csharp
[FieldPermission(
    CREATE = "EMPLEADO.CODIGOEQUIPO.CREATE",
    UPDATE = "EMPLEADO.CODIGOEQUIPO.EDIT"
)]
public string CodigoEquipo;
```

---

## ğŸ”§ Usando la Herramienta

### **Herramienta Python**
```bash
# Aplicar FieldPermission a un campo
python tools/entities/customvalidator.py empleado:SueldoBase:FieldPermission

# MÃºltiples campos
python tools/entities/customvalidator.py empleado:SueldoBase:FieldPermission empleado:Bonificacion:FieldPermission

# Ver entidades disponibles
python tools/entities/customvalidator.py --list
```

### **Atributos Disponibles**
- `SoloCrear`: Campo modificable solo en creaciÃ³n
- `AutoIncremental`: NumeraciÃ³n automÃ¡tica
- `NoSelect`: Campo siempre oculto
- `FieldPermission`: Permisos granulares â­

---

## ğŸš¨ Troubleshooting

### **Problema: Campo No Se Oculta**
```
Campo visible cuando no deberÃ­a serlo
```
**SoluciÃ³n**: Verificar que el usuario no tenga el permiso `VIEW`
```csharp
// Revisar en base de datos
SELECT * FROM SystemUsersPermissions WHERE ActionKey = 'ENTIDAD.CAMPO.VIEW'
```

### **Problema: No Se Bloquea CreaciÃ³n/Update**
```
UnauthorizedAccessException no aparece
```
**SoluciÃ³n**: Verificar interceptores registrados
```csharp
// En Program.cs debe estar:
builder.Services.AddHandlersFromAssemblies(typeof(Program));
```

### **Problema: Error de Metadata**
```
FieldPermission no se detecta
```
**SoluciÃ³n**: Verificar archivo `.Metadata.cs` generado
```csharp
// Debe existir: Entidad.Metadata.cs
// Con: [MetadataType(typeof(EntidadMetadata))]
```

---

## ğŸ¯ Mejores PrÃ¡cticas

### **1. ConvenciÃ³n de Nombres**
```
Formato: ENTIDAD.CAMPO.OPERACION
Ejemplos:
- EMPLEADO.SUELDOBASE.VIEW
- EMPLEADO.SUELDOBASE.CREATE  
- EMPLEADO.SUELDOBASE.EDIT
```

### **2. OrganizaciÃ³n por Grupos**
```sql
INSERT INTO SystemPermissions (Grupo, ActionKey) VALUES
('RRHH', 'EMPLEADO.SUELDOBASE.VIEW'),
('RRHH', 'EMPLEADO.SUELDOBASE.EDIT'),
('FINANZAS', 'EMPLEADO.BONIFICACION.VIEW');
```

### **3. Documentar Campos Protegidos**
```csharp
/// <summary>
/// Sueldo base del empleado
/// Requiere permisos RRHH para ver/modificar
/// </summary>
[FieldPermission(
    CREATE = "EMPLEADO.SUELDOBASE.CREATE",
    UPDATE = "EMPLEADO.SUELDOBASE.EDIT", 
    VIEW = "EMPLEADO.SUELDOBASE.VIEW"
)]
public decimal? SueldoBase { get; set; }
```

### **4. Testing de Permisos**
```csharp
// Probar con usuario sin permisos
// GET â†’ Campo debe ser null
// POST/PUT â†’ Debe devolver 403 Unauthorized
```

---

## ğŸš€ Sistema Force Operations

### **Â¿CuÃ¡ndo Usar Force?**

El sistema Force permite **bypasear** temporalmente las validaciones de FieldPermission para casos especÃ­ficos donde:

- âœ… **Procesos AutomÃ¡ticos**: El sistema actualiza campos que el usuario no puede tocar directamente
- âœ… **Aprobaciones**: Juan aprueba â†’ El sistema actualiza automÃ¡ticamente el sueldo
- âœ… **Importaciones**: Carga masiva de datos con permisos elevados
- âœ… **Reportes Especiales**: AuditorÃ­as que necesitan ver todos los campos

### **Force SaveChanges**

```csharp
// OperaciÃ³n normal - aplica validaciones FieldPermission
await _context.SaveChangesAsync();

// Force - saltea validaciones FieldPermission
await _context.ForceSaveChangesAsync();
await _context.ForceSaveChangesAsync("Juan aprobÃ³ solicitud de aumento");
```

### **Force Queries**

```csharp
// OperaciÃ³n normal - oculta campos sin permisos VIEW
var empleados = await _context.Empleados.ToListAsync();

// Force - muestra todos los campos sin importar permisos VIEW  
var empleados = await _context.Empleados.ForceToListAsync();
var empleados = await _context.Empleados.ForceToListAsync("Reporte para auditorÃ­a");

// TambiÃ©n disponible:
var empleado = await query.ForceFirstOrDefaultAsync();
var count = await query.ForceCountAsync(); 
bool exists = await query.ForceAnyAsync();
```

### **Ejemplo Completo: AprobaciÃ³n de Solicitud**

```csharp
public async Task AprobarSolicitudAumentoAsync(Guid solicitudId, Guid usuarioAprobadorId)
{
    // 1. Obtener datos con Force (ver campos protegidos para validaciÃ³n)
    var solicitud = await _context.SolicitudesAumento
        .Where(s => s.Id == solicitudId)
        .ForceFirstOrDefaultAsync("Proceso de aprobaciÃ³n");
        
    var empleado = await _context.Empleados
        .Where(e => e.Id == solicitud.EmpleadoId) 
        .ForceFirstOrDefaultAsync("Proceso de aprobaciÃ³n");

    // 2. Validar y actualizar
    solicitud.Estado = "Aprobada";
    solicitud.AprobadoPor = usuarioAprobadorId;
    
    // Campo protegido que normalmente requiere EMPLEADO.SUELDOBASE.EDIT
    empleado.SueldoBase = solicitud.NuevoSueldo;

    // 3. Guardar con Force (saltear validaciones FieldPermission)
    await _context.ForceSaveChangesAsync($"AprobaciÃ³n automÃ¡tica #{solicitudId}");
}
```

### **âš ï¸ Consideraciones de Seguridad**

- **Solo usar cuando sea necesario**: Force es para casos excepcionales
- **Documentar la razÃ³n**: Siempre pasar el parÃ¡metro `reason`
- **AuditorÃ­a**: Se registra en logs cuÃ¡ndo se usa Force
- **Thread-Safe**: Cada operaciÃ³n mantiene su propio contexto Force

### **Logging del Sistema Force**

```
ğŸš€ FORCE MODE: Saltando validaciones FieldPermission - RazÃ³n: Juan aprobÃ³ solicitud de aumento
ğŸš€ FORCE MODE: Saltando ocultaciÃ³n de campos FieldPermission - RazÃ³n: Reporte para auditorÃ­a
```

---

## ğŸ“Š Consideraciones de Performance

- **Thread-Safe**: Cada request mantiene su contexto de usuario
- **Cache por Request**: Usuario se valida una vez por peticiÃ³n HTTP
- **MÃ­nimo Overhead**: Solo procesa campos con `FieldPermission`
- **Multiusuario**: Sin race conditions ni shared state
- **Force Context**: `AsyncLocal<T>` para contexto por operaciÃ³n

---

## ğŸ”„ Versionado y MigraciÃ³n

### **Agregar Nuevos Campos Protegidos**
1. Aplicar atributo `FieldPermission`
2. Generar metadata con herramienta Python
3. Crear permisos en base de datos
4. Asignar permisos a roles/usuarios

### **Modificar Permisos Existentes**
1. Actualizar atributo en metadata
2. Modificar permisos en base de datos
3. Verificar asignaciones de roles

---

**âœ¨ El sistema estÃ¡ diseÃ±ado para ser invisible al desarrollador - solo agrega el atributo y funciona automÃ¡ticamente.**