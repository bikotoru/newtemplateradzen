# 🔒 Sistema de Permisos a Nivel de Campo

## 📖 Índice

1. [Introducción](#introducción)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
3. [Guía de Uso Rápido](#guía-de-uso-rápido)
4. [Configuración de Campos](#configuración-de-campos)
5. [Tipos de Permisos](#tipos-de-permisos)
6. [Ejemplos Prácticos](#ejemplos-prácticos)
7. [Sistema Force Operations](#sistema-force-operations) ⭐
8. [Troubleshooting](#troubleshooting)
9. [Mejores Prácticas](#mejores-prácticas)

---

## 🎯 Introducción

El Sistema de Permisos a Nivel de Campo permite proteger campos específicos de las entidades con permisos granulares. Está diseñado para ser:

- ✅ **Granular**: Control por campo individual
- ✅ **Automático**: Sin código adicional en controladores
- ✅ **Thread-Safe**: Seguro para sistemas multiusuario
- ✅ **Performante**: Mínimo overhead en operaciones
- ✅ **Extensible**: Fácil agregar más campos protegidos

---

## 🏗️ Arquitectura del Sistema

### Componentes Principales

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│ FieldPermission │    │  CurrentUser     │    │ EF Interceptors │
│   Attribute     │ ── │    Service       │ ── │    System       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│     Metadata    │    │   Permission     │    │    Query &      │
│    Generation   │    │   Validation     │    │  Save Handlers  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Flujo de Operaciones

1. **VIEW (Consultas)**: `NoSelectQueryInterceptor` oculta campos automáticamente
2. **CREATE (Crear)**: `FieldPermissionSaveHandler` valida antes de insertar
3. **UPDATE (Actualizar)**: `FieldPermissionSaveHandler` valida antes de modificar

---

## 🚀 Guía de Uso Rápido

### **Paso 1: Agregar Atributo a Campo**
```csharp
[FieldPermission(
    CREATE = "EMPLEADO.SUELDOBASE.CREATE",
    UPDATE = "EMPLEADO.SUELDOBASE.EDIT", 
    VIEW = "EMPLEADO.SUELDOBASE.VIEW"
)]
public decimal? SueldoBase { get; set; }
```

### **Paso 2: Generar Metadata**
```bash
python tools/entities/customvalidator.py empleado:SueldoBase:FieldPermission
```

### **Paso 3: Crear Permisos en Base de Datos**
```sql
INSERT INTO SystemPermissions (Nombre, ActionKey, Grupo, Active) VALUES
('Ver Sueldo Base', 'EMPLEADO.SUELDOBASE.VIEW', 'RRHH', 1),
('Crear Sueldo Base', 'EMPLEADO.SUELDOBASE.CREATE', 'RRHH', 1),
('Editar Sueldo Base', 'EMPLEADO.SUELDOBASE.EDIT', 'RRHH', 1);
```

### **¡Listo!** El sistema automáticamente:
- ❌ Oculta `SueldoBase` si no tienes permiso `VIEW`
- ❌ Bloquea creación si no tienes permiso `CREATE`  
- ❌ Bloquea actualización si no tienes permiso `UPDATE`

---

## 🔧 Configuración de Campos

### **Sintaxis del Atributo**
```csharp
[FieldPermission(
    CREATE = "ENTIDAD.CAMPO.CREATE",  // Opcional
    UPDATE = "ENTIDAD.CAMPO.EDIT",    // Opcional  
    VIEW = "ENTIDAD.CAMPO.VIEW"       // Opcional
)]
public TipoDato NombreCampo { get; set; }
```

### **Ubicación: Metadata Files**
```csharp
// Empleado.Metadata.cs
[MetadataType(typeof(EmpleadoMetadata))]
public partial class Empleado { }

public class EmpleadoMetadata
{
    [FieldPermission(
        CREATE = "EMPLEADO.SUELDOBASE.CREATE",
        UPDATE = "EMPLEADO.SUELDOBASE.EDIT", 
        VIEW = "EMPLEADO.SUELDOBASE.VIEW"
    )]
    public string SueldoBase;
}
```

---

## 🎭 Tipos de Permisos

### **CREATE** - Control de Creación
- **Cuándo se valida**: Al insertar nueva entidad
- **Comportamiento**: Si no tiene permiso → `UnauthorizedAccessException`
- **Ejemplo**: Evitar que usuarios creen empleados con sueldo

### **UPDATE** - Control de Actualización  
- **Cuándo se valida**: Al modificar entidad existente
- **Comportamiento**: Si no tiene permiso → `UnauthorizedAccessException`
- **Ejemplo**: Solo RRHH puede modificar sueldos existentes

### **VIEW** - Control de Visualización
- **Cuándo se valida**: Al consultar entidades
- **Comportamiento**: Si no tiene permiso → Campo = `null`
- **Ejemplo**: Ocultar sueldos a usuarios sin autorización

---

## 🧪 Ejemplos Prácticos

### **Ejemplo 1: Proteger Sueldo Base**
```csharp
// 1. En Empleado.Metadata.cs
[FieldPermission(
    CREATE = "EMPLEADO.SUELDOBASE.CREATE",
    UPDATE = "EMPLEADO.SUELDOBASE.EDIT", 
    VIEW = "EMPLEADO.SUELDOBASE.VIEW"
)]
public string SueldoBase;

// 2. Generar metadata
// python tools/entities/customvalidator.py empleado:SueldoBase:FieldPermission

// 3. Resultado automático:
// - GET /empleados → SueldoBase = null (sin permiso VIEW)
// - POST /empleados → Error 403 (sin permiso CREATE)
// - PUT /empleados → Error 403 (sin permiso UPDATE)
```

### **Ejemplo 2: Solo Proteger Visualización**
```csharp
[FieldPermission(VIEW = "EMPLEADO.DOCUMENTO.VIEW")]
public string NumeroDocumento;
```

### **Ejemplo 3: Solo Proteger Modificación**
```csharp
[FieldPermission(
    CREATE = "EMPLEADO.CODIGOEQUIPO.CREATE",
    UPDATE = "EMPLEADO.CODIGOEQUIPO.EDIT"
)]
public string CodigoEquipo;
```

---

## 🔧 Usando la Herramienta

### **Herramienta Python**
```bash
# Aplicar FieldPermission a un campo
python tools/entities/customvalidator.py empleado:SueldoBase:FieldPermission

# Múltiples campos
python tools/entities/customvalidator.py empleado:SueldoBase:FieldPermission empleado:Bonificacion:FieldPermission

# Ver entidades disponibles
python tools/entities/customvalidator.py --list
```

### **Atributos Disponibles**
- `SoloCrear`: Campo modificable solo en creación
- `AutoIncremental`: Numeración automática
- `NoSelect`: Campo siempre oculto
- `FieldPermission`: Permisos granulares ⭐

---

## 🚨 Troubleshooting

### **Problema: Campo No Se Oculta**
```
Campo visible cuando no debería serlo
```
**Solución**: Verificar que el usuario no tenga el permiso `VIEW`
```csharp
// Revisar en base de datos
SELECT * FROM SystemUsersPermissions WHERE ActionKey = 'ENTIDAD.CAMPO.VIEW'
```

### **Problema: No Se Bloquea Creación/Update**
```
UnauthorizedAccessException no aparece
```
**Solución**: Verificar interceptores registrados
```csharp
// En Program.cs debe estar:
builder.Services.AddHandlersFromAssemblies(typeof(Program));
```

### **Problema: Error de Metadata**
```
FieldPermission no se detecta
```
**Solución**: Verificar archivo `.Metadata.cs` generado
```csharp
// Debe existir: Entidad.Metadata.cs
// Con: [MetadataType(typeof(EntidadMetadata))]
```

---

## 🎯 Mejores Prácticas

### **1. Convención de Nombres**
```
Formato: ENTIDAD.CAMPO.OPERACION
Ejemplos:
- EMPLEADO.SUELDOBASE.VIEW
- EMPLEADO.SUELDOBASE.CREATE  
- EMPLEADO.SUELDOBASE.EDIT
```

### **2. Organización por Grupos**
```sql
INSERT INTO SystemPermissions (Grupo, ActionKey) VALUES
('RRHH', 'EMPLEADO.SUELDOBASE.VIEW'),
('RRHH', 'EMPLEADO.SUELDOBASE.EDIT'),
('FINANZAS', 'EMPLEADO.BONIFICACION.VIEW');
```

### **3. Documentar Campos Protegidos**
```csharp
/// <summary>
/// Sueldo base del empleado
/// Requiere permisos RRHH para ver/modificar
/// </summary>
[FieldPermission(
    CREATE = "EMPLEADO.SUELDOBASE.CREATE",
    UPDATE = "EMPLEADO.SUELDOBASE.EDIT", 
    VIEW = "EMPLEADO.SUELDOBASE.VIEW"
)]
public decimal? SueldoBase { get; set; }
```

### **4. Testing de Permisos**
```csharp
// Probar con usuario sin permisos
// GET → Campo debe ser null
// POST/PUT → Debe devolver 403 Unauthorized
```

---

## 🚀 Sistema Force Operations

### **¿Cuándo Usar Force?**

El sistema Force permite **bypasear** temporalmente las validaciones de FieldPermission para casos específicos donde:

- ✅ **Procesos Automáticos**: El sistema actualiza campos que el usuario no puede tocar directamente
- ✅ **Aprobaciones**: Juan aprueba → El sistema actualiza automáticamente el sueldo
- ✅ **Importaciones**: Carga masiva de datos con permisos elevados
- ✅ **Reportes Especiales**: Auditorías que necesitan ver todos los campos

### **Force SaveChanges**

```csharp
// Operación normal - aplica validaciones FieldPermission
await _context.SaveChangesAsync();

// Force - saltea validaciones FieldPermission
await _context.ForceSaveChangesAsync();
await _context.ForceSaveChangesAsync("Juan aprobó solicitud de aumento");
```

### **Force Queries**

```csharp
// Operación normal - oculta campos sin permisos VIEW
var empleados = await _context.Empleados.ToListAsync();

// Force - muestra todos los campos sin importar permisos VIEW  
var empleados = await _context.Empleados.ForceToListAsync();
var empleados = await _context.Empleados.ForceToListAsync("Reporte para auditoría");

// También disponible:
var empleado = await query.ForceFirstOrDefaultAsync();
var count = await query.ForceCountAsync(); 
bool exists = await query.ForceAnyAsync();
```

### **Ejemplo Completo: Aprobación de Solicitud**

```csharp
public async Task AprobarSolicitudAumentoAsync(Guid solicitudId, Guid usuarioAprobadorId)
{
    // 1. Obtener datos con Force (ver campos protegidos para validación)
    var solicitud = await _context.SolicitudesAumento
        .Where(s => s.Id == solicitudId)
        .ForceFirstOrDefaultAsync("Proceso de aprobación");
        
    var empleado = await _context.Empleados
        .Where(e => e.Id == solicitud.EmpleadoId) 
        .ForceFirstOrDefaultAsync("Proceso de aprobación");

    // 2. Validar y actualizar
    solicitud.Estado = "Aprobada";
    solicitud.AprobadoPor = usuarioAprobadorId;
    
    // Campo protegido que normalmente requiere EMPLEADO.SUELDOBASE.EDIT
    empleado.SueldoBase = solicitud.NuevoSueldo;

    // 3. Guardar con Force (saltear validaciones FieldPermission)
    await _context.ForceSaveChangesAsync($"Aprobación automática #{solicitudId}");
}
```

### **⚠️ Consideraciones de Seguridad**

- **Solo usar cuando sea necesario**: Force es para casos excepcionales
- **Documentar la razón**: Siempre pasar el parámetro `reason`
- **Auditoría**: Se registra en logs cuándo se usa Force
- **Thread-Safe**: Cada operación mantiene su propio contexto Force

### **Logging del Sistema Force**

```
🚀 FORCE MODE: Saltando validaciones FieldPermission - Razón: Juan aprobó solicitud de aumento
🚀 FORCE MODE: Saltando ocultación de campos FieldPermission - Razón: Reporte para auditoría
```

---

## 📊 Consideraciones de Performance

- **Thread-Safe**: Cada request mantiene su contexto de usuario
- **Cache por Request**: Usuario se valida una vez por petición HTTP
- **Mínimo Overhead**: Solo procesa campos con `FieldPermission`
- **Multiusuario**: Sin race conditions ni shared state
- **Force Context**: `AsyncLocal<T>` para contexto por operación

---

## 🔄 Versionado y Migración

### **Agregar Nuevos Campos Protegidos**
1. Aplicar atributo `FieldPermission`
2. Generar metadata con herramienta Python
3. Crear permisos en base de datos
4. Asignar permisos a roles/usuarios

### **Modificar Permisos Existentes**
1. Actualizar atributo en metadata
2. Modificar permisos en base de datos
3. Verificar asignaciones de roles

---

**✨ El sistema está diseñado para ser invisible al desarrollador - solo agrega el atributo y funciona automáticamente.**