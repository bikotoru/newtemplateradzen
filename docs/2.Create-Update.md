# Sistema de Create y Update - Documentación

## Resumen del Sistema

Sistema completo de **creación y actualización de entidades** con **builders fuertemente tipados**, **validación automática de FK** y **operaciones por lotes**. Incluye **selección de campos**, **relaciones automáticas** y **validaciones inteligentes**.

## Arquitectura de Archivos

### Backend
- `Backend.Utils/Services/BaseQueryService.cs` - Lógica de Create/Update con validaciones FK
- `Backend/Controllers/BaseQueryController.cs` - Endpoints Create/Update individuales y batch

### Frontend  
- `Frontend/Services/BaseApiService.cs` - Métodos HTTP para Create/Update
- `Shared.Models/Builders/CreateRequestBuilder.cs` - Builder para CreateRequest
- `Shared.Models/Builders/UpdateRequestBuilder.cs` - Builder para UpdateRequest

### Shared
- `Shared.Models/Requests/CreateRequest.cs` - Request model para creación
- `Shared.Models/Requests/UpdateRequest.cs` - Request model para actualización
- `Shared.Models/Requests/CreateBatchRequest.cs` - Request para creación por lotes
- `Shared.Models/Requests/UpdateBatchRequest.cs` - Request para actualización por lotes

## Endpoints Disponibles

### Operaciones Individuales
- `POST /api/{entity}/create` - Crear una entidad
- `PUT /api/{entity}/update` - Actualizar una entidad

### Operaciones por Lotes
- `POST /api/{entity}/create-batch` - Crear múltiples entidades
- `PUT /api/{entity}/update-batch` - Actualizar múltiples entidades

## Request Models

### CreateRequest<T>
```csharp
public class CreateRequest<T>
{
    public T Entity { get; set; }                                    // Entidad a crear
    public Expression<Func<T, object>>[]? CreateFields { get; set; } // Campos a incluir
    public string[]? IncludeRelations { get; set; }                  // Relaciones a incluir
    public bool AutoCreateRelations { get; set; } = false;           // Crear relaciones automáticamente
    public string[]? IncludeCollections { get; set; }                // Colecciones a incluir
    public Dictionary<string, object>? AdditionalData { get; set; }  // Datos adicionales
}
```

### UpdateRequest<T>
```csharp
public class UpdateRequest<T>
{
    public T Entity { get; set; }                                    // Entidad a actualizar
    public Expression<Func<T, object>>[]? UpdateFields { get; set; } // Campos a actualizar
    public string[]? IncludeRelations { get; set; }                  // Relaciones a incluir
    public bool UpdateRelations { get; set; } = false;               // Actualizar relaciones
    public string[]? IncludeCollections { get; set; }                // Colecciones a incluir
    public Dictionary<string, object>? AdditionalData { get; set; }  // Datos adicionales
}
```

## Uso de Builders

### 1. CreateRequestBuilder - Creación Simple
```csharp
// En CategoriaService.cs
public async Task<ApiResponse<Categoria>> CrearCategoriaAsync(Categoria categoria)
{
    var request = new CreateRequestBuilder<Categoria>(categoria)
        .WithFields(c => c.Nombre, c => c.Descripcion, c => c.Codigo)
        .Including("Creador")
        .Build();

    return await CreateAsync(request);
}
```

### 2. CreateRequestBuilder - Con Relaciones Automáticas
```csharp
public async Task<ApiResponse<Categoria>> CrearConUsuarioAsync(Categoria categoria)
{
    var request = new CreateRequestBuilder<Categoria>(categoria)
        .WithFields(c => c.Nombre, c => c.Descripcion, c => c.CreadorId)
        .Including("Creador")
        .WithAutoCreate(true)  // Crea Usuario si no existe
        .Build();

    return await CreateAsync(request);
}
```

### 3. CreateRequestBuilder - Con Colecciones
```csharp
public async Task<ApiResponse<Usuario>> CrearUsuarioCompletoAsync(Usuario usuario)
{
    var request = new CreateRequestBuilder<Usuario>(usuario)
        .WithFields(u => u.Nombre, u => u.Email, u => u.Password)
        .IncludingCollection("Categorias", "Documentos")
        .WithAutoCreate(true)
        .Build();

    return await CreateAsync(request);
}
```

### 4. UpdateRequestBuilder - Actualización Parcial
```csharp
public async Task<ApiResponse<Categoria>> ActualizarNombreAsync(Guid id, string nuevoNombre)
{
    var categoria = new Categoria { Id = id, Nombre = nuevoNombre };
    
    var request = new UpdateRequestBuilder<Categoria>(categoria)
        .WithFields(c => c.Nombre)  // Solo actualiza el nombre
        .Build();

    return await UpdateAsync(request);
}
```

### 5. UpdateRequestBuilder - Con Relaciones
```csharp
public async Task<ApiResponse<Categoria>> ActualizarCompleta(Categoria categoria)
{
    var request = new UpdateRequestBuilder<Categoria>(categoria)
        .WithFields(c => c.Nombre, c => c.Descripcion, c => c.CreadorId)
        .Including("Creador")
        .WithUpdateRelations(true)  // Actualiza relaciones también
        .Build();

    return await UpdateAsync(request);
}
```

## Operaciones por Lotes

### 1. Crear Múltiples Entidades
```csharp
public async Task<ApiResponse<BatchResponse<Categoria>>> CrearCategoriasLoteAsync(
    List<Categoria> categorias)
{
    // Crear requests individuales
    var requests = categorias.Select(c => 
        new CreateRequestBuilder<Categoria>(c)
            .WithFields(cat => cat.Nombre, cat => cat.Descripcion)
            .Including("Creador")
            .Build()
    ).ToList();

    // Crear batch request
    var batchRequest = new CreateBatchRequest<Categoria>
    {
        Requests = requests,
        ContinueOnError = true,  // Continúa si una falla
        ValidateForeignKeys = true
    };

    return await CreateBatchAsync(batchRequest);
}
```

### 2. Actualizar Múltiples Entidades
```csharp
public async Task<ApiResponse<BatchResponse<Categoria>>> ActualizarLoteAsync(
    List<Categoria> categorias)
{
    var requests = categorias.Select(c => 
        new UpdateRequestBuilder<Categoria>(c)
            .WithFields(cat => cat.Nombre, cat => cat.Descripcion)
            .Build()
    ).ToList();

    var batchRequest = new UpdateBatchRequest<Categoria>
    {
        Requests = requests,
        ContinueOnError = false,  // Para si una falla
        ValidateForeignKeys = true
    };

    return await UpdateBatchAsync(batchRequest);
}
```

## Validaciones Automáticas

### 1. Validación de Foreign Keys
```csharp
// El sistema valida automáticamente que existan las relaciones
public async Task<ApiResponse<Categoria>> CrearConValidacionAsync(Categoria categoria)
{
    // Si CreadorId no existe en la tabla Usuarios, el sistema devuelve error
    var request = new CreateRequestBuilder<Categoria>(categoria)
        .WithFields(c => c.Nombre, c => c.CreadorId)
        .Build();

    return await CreateAsync(request);  // Valida que CreadorId exista
}
```

### 2. Validación de Campos Requeridos
```csharp
public async Task<ApiResponse<Categoria>> CrearConCamposRequeridos(Categoria categoria)
{
    var request = new CreateRequestBuilder<Categoria>(categoria)
        .WithFields(c => c.Nombre, c => c.Codigo)  // Solo estos campos se crearán
        // Si Descripcion es requerida pero no se incluye, devuelve error
        .Build();

    return await CreateAsync(request);
}
```

## Uso en Componentes Blazor

### 1. Crear Entidad desde Form
```csharp
// En CrearCategoria.razor.cs
private Categoria categoria = new();

private async Task GuardarAsync()
{
    try
    {
        var response = await categoriaService.CreateAsync(
            new CreateRequestBuilder<Categoria>(categoria)
                .WithFields(c => c.Nombre, c => c.Descripcion, c => c.CreadorId)
                .Including("Creador")
                .Build()
        );

        if (response.Success)
        {
            // Redirigir o mostrar mensaje de éxito
            NavigationManager.NavigateTo("/categorias");
        }
        else
        {
            // Mostrar errores
            errorMessage = response.Message;
        }
    }
    catch (Exception ex)
    {
        errorMessage = ex.Message;
    }
}
```

### 2. Actualizar desde Grid
```csharp
// En EditarCategoria.razor.cs
private async Task ActualizarCategoriaAsync(Categoria categoria)
{
    var response = await categoriaService.UpdateAsync(
        new UpdateRequestBuilder<Categoria>(categoria)
            .WithFields(c => c.Nombre, c => c.Descripcion)
            // No actualizar CreadorId por seguridad
            .Build()
    );

    if (response.Success)
    {
        await grid.Reload();  // Recargar grid
        StateHasChanged();
    }
}
```

### 3. Import Masivo
```csharp
// En ImportCategoria.razor.cs
private async Task ImportarExcelAsync(List<Categoria> categoriasFromExcel)
{
    var response = await categoriaService.CreateBatchAsync(
        new CreateBatchRequest<Categoria>
        {
            Requests = categoriasFromExcel.Select(c => 
                new CreateRequestBuilder<Categoria>(c)
                    .WithFields(cat => cat.Nombre, cat => cat.Descripcion, cat => cat.Codigo)
                    .Build()
            ).ToList(),
            ContinueOnError = true,  // Continúa aunque algunas fallen
            ValidateForeignKeys = true
        }
    );

    // Mostrar resultados
    if (response.Success && response.Data != null)
    {
        var exitosos = response.Data.SuccessfulOperations?.Count ?? 0;
        var fallidos = response.Data.FailedOperations?.Count ?? 0;
        
        mensaje = $"Importados: {exitosos}, Fallidos: {fallidos}";
    }
}
```

## Manejo de Response

### BatchResponse<T>
```csharp
public class BatchResponse<T>
{
    public List<T>? SuccessfulOperations { get; set; }           // Operaciones exitosas
    public List<BatchOperationError>? FailedOperations { get; set; } // Operaciones fallidas
    public int TotalProcessed { get; set; }                      // Total procesadas
    public int SuccessCount { get; set; }                        // Exitosas
    public int FailureCount { get; set; }                        // Fallidas
    public bool ContinuedOnError { get; set; }                   // Si continuó con errores
}
```

### Manejo de Errores en Batch
```csharp
private async Task ProcesarBatchResponse(ApiResponse<BatchResponse<Categoria>> response)
{
    if (response.Success && response.Data != null)
    {
        var batch = response.Data;
        
        Console.WriteLine($"Total: {batch.TotalProcessed}");
        Console.WriteLine($"Exitosas: {batch.SuccessCount}");
        Console.WriteLine($"Fallidas: {batch.FailureCount}");

        // Mostrar errores específicos
        if (batch.FailedOperations?.Any() == true)
        {
            foreach (var error in batch.FailedOperations)
            {
                Console.WriteLine($"Error en índice {error.Index}: {error.ErrorMessage}");
            }
        }
    }
}
```

## Patrones Avanzados

### 1. Create con Datos Adicionales
```csharp
public async Task<ApiResponse<Categoria>> CrearConMetadataAsync(Categoria categoria, string origen)
{
    var request = new CreateRequestBuilder<Categoria>(categoria)
        .WithFields(c => c.Nombre, c => c.Descripcion)
        .WithAdditionalData("Origen", origen)
        .WithAdditionalData("FechaImport", DateTime.Now)
        .Build();

    return await CreateAsync(request);
}
```

### 2. Update Condicional
```csharp
public async Task<ApiResponse<Categoria>> ActualizarSiActivaAsync(Categoria categoria)
{
    // Primero verificar si está activa
    var existing = await GetByIdAsync(categoria.Id);
    if (!existing.Success || existing.Data?.Active != true)
    {
        return ApiResponse<Categoria>.ErrorResponse("Categoría no activa o no existe");
    }

    var request = new UpdateRequestBuilder<Categoria>(categoria)
        .WithFields(c => c.Nombre, c => c.Descripcion)
        .Build();

    return await UpdateAsync(request);
}
```

## Implementar en Nueva Entidad

### 1. Service Methods
```csharp
public class MiEntidadService : BaseApiService<MiEntidad>
{
    // Automáticamente hereda:
    // - CreateAsync(CreateRequest<MiEntidad>)
    // - UpdateAsync(UpdateRequest<MiEntidad>)
    // - CreateBatchAsync(CreateBatchRequest<MiEntidad>)
    // - UpdateBatchAsync(UpdateBatchRequest<MiEntidad>)

    // Solo agregar métodos custom
    public async Task<ApiResponse<MiEntidad>> CrearRapidoAsync(string nombre)
    {
        var entidad = new MiEntidad { Nombre = nombre };
        var request = new CreateRequestBuilder<MiEntidad>(entidad)
            .WithFields(e => e.Nombre)
            .Build();

        return await CreateAsync(request);
    }
}
```

### 2. Component Usage
```csharp
// En el component
private async Task CrearAsync()
{
    var response = await miEntidadService.CreateAsync(
        new CreateRequestBuilder<MiEntidad>(entidad)
            .WithFields(e => e.Nombre, e => e.Descripcion)
            .Build()
    );

    if (response.Success)
    {
        // Éxito
    }
}
```

**¡El sistema CRUD está listo!** Provee **validaciones automáticas**, **operaciones por lotes**, **builders tipados** y **manejo de errores** robusto para cualquier entidad.