# üìã Sistema de Auditor√≠a Autom√°tica

## üìñ √çndice

1. [Introducci√≥n](#introducci√≥n)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
3. [Gu√≠a de Uso R√°pido](#gu√≠a-de-uso-r√°pido)
4. [Configuraci√≥n de Campos](#configuraci√≥n-de-campos)
5. [Estructura de Datos](#estructura-de-datos)
6. [Ejemplos Pr√°cticos](#ejemplos-pr√°cticos)
7. [Integraci√≥n con Force Operations](#integraci√≥n-con-force-operations)
8. [Consulta y An√°lisis de Auditor√≠a](#consulta-y-an√°lisis-de-auditor√≠a)
9. [Troubleshooting](#troubleshooting)
10. [Mejores Pr√°cticas](#mejores-pr√°cticas)

---

## üéØ Introducci√≥n

El Sistema de Auditor√≠a Autom√°tica permite registrar autom√°ticamente todos los cambios realizados en campos espec√≠ficos de las entidades. Est√° dise√±ado para ser:

- ‚úÖ **Transparente**: Solo marcar campos con `[Auditar]`
- ‚úÖ **Autom√°tico**: Sin c√≥digo adicional en controladores
- ‚úÖ **Completo**: Registra CREATE y UPDATE con valores anteriores/nuevos
- ‚úÖ **Integrado**: Compatible con Force Operations y comentarios
- ‚úÖ **Eficiente**: Solo audita campos que realmente cambiaron
- ‚úÖ **Thread-Safe**: Seguro para sistemas multiusuario

---

## üèóÔ∏è Arquitectura del Sistema

### Componentes Principales

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ AuditarAttribute‚îÇ    ‚îÇ AuditoriaSave    ‚îÇ    ‚îÇ SystemAuditoria ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ   Interceptor    ‚îÇ    ‚îÇ     Entity      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Metadata    ‚îÇ    ‚îÇ   Change         ‚îÇ    ‚îÇ    Database     ‚îÇ
‚îÇ    Detection    ‚îÇ    ‚îÇ  Tracking        ‚îÇ    ‚îÇ     Storage     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flujo de Operaciones

1. **DETECT**: `AuditoriaSaveInterceptor` detecta campos con `[Auditar]`
2. **TRACK**: Captura valores anteriores y nuevos durante SaveChanges
3. **STORE**: Guarda registros de auditor√≠a en `system_auditoria`
4. **COMMENT**: Incluye comentarios de Force Operations si existen

---

## üöÄ Gu√≠a de Uso R√°pido

### **Paso 1: Marcar Campo para Auditor√≠a**

```bash
python tools/entities/customvalidator.py empleado:SueldoBase:Auditar
```

### **Paso 2: El Sistema Funciona Autom√°ticamente**

```csharp
// Operaci√≥n normal - auditor√≠a autom√°tica
var empleado = await _context.Empleados.FirstAsync();
empleado.SueldoBase = 5000;
await _context.SaveChangesAsync();

// Con comentario usando Force
await _context.ForceSaveChangesAsync("Aumento por promoci√≥n");
```

### **¬°Listo!** El sistema autom√°ticamente:
- üìù Registra el cambio en `system_auditoria`
- üíæ Guarda valor anterior y nuevo en JSON
- üè∑Ô∏è Incluye comentario si se us√≥ Force
- üë§ Registra usuario que hizo el cambio
- üè¢ Mantiene contexto organizacional

---

## üîß Configuraci√≥n de Campos

### **Sintaxis del Atributo**
```csharp
[Auditar]
public decimal? SueldoBase { get; set; }
```

### **Ubicaci√≥n: Metadata Files**
```csharp
// Empleado.Metadata.cs (generado autom√°ticamente)
[MetadataType(typeof(EmpleadoMetadata))]
public partial class Empleado { }

public class EmpleadoMetadata
{
    [Auditar]
    public string SueldoBase;
    
    [Auditar]
    public string Bonificacion;
}
```

---

## üóÉÔ∏è Estructura de Datos

### **Tabla `system_auditoria`**

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `Id` | GUID | Identificador √∫nico del registro |
| `Tabla` | VARCHAR(255) | Nombre de la entidad auditada |
| `RegistroId` | GUID | ID del registro que se modific√≥ |
| `Action` | VARCHAR(50) | Acci√≥n realizada: "CREATE" o "UPDATE" |
| `ValorAnterior` | TEXT | Valores anteriores en formato JSON (null para CREATE) |
| `NuevoValor` | TEXT | Valores nuevos en formato JSON |
| `Comentario` | VARCHAR(1000) | Comentario opcional (del Force operation) |
| `OrganizationId` | GUID | Organizaci√≥n del usuario |
| `CreadorId` | GUID | Usuario que realiz√≥ el cambio |
| `FechaCreacion` | DATETIME | Fecha del cambio |
| `Active` | BIT | Estado del registro |

### **Ejemplo de Datos JSON**

```json
// ValorAnterior (UPDATE)
{
  "SueldoBase": 3000,
  "Bonificacion": 200
}

// NuevoValor
{
  "SueldoBase": 5000,
  "Bonificacion": 500
}
```

---

## üß™ Ejemplos Pr√°cticos

### **Ejemplo 1: Auditar Sueldo Base**

```bash
# 1. Marcar campo para auditor√≠a
python tools/entities/customvalidator.py empleado:SueldoBase:Auditar
```

```csharp
// 2. Resultado autom√°tico en Empleado.Metadata.cs
[Auditar]
public string SueldoBase;

// 3. Usar normalmente en c√≥digo
var empleado = new Empleado 
{ 
    Nombre = "Juan P√©rez",
    SueldoBase = 3000  // ‚Üê Campo auditado
};
await _context.AddAsync(empleado);
await _context.SaveChangesAsync(); // Genera registro CREATE

// 4. Modificar campo auditado
empleado.SueldoBase = 5000;
await _context.SaveChangesAsync(); // Genera registro UPDATE

// 5. Resultado en system_auditoria:
// CREATE: {"SueldoBase": 3000}
// UPDATE: Anterior={"SueldoBase": 3000}, Nuevo={"SueldoBase": 5000}
```

### **Ejemplo 2: Auditor√≠a con Comentarios Force**

```csharp
public async Task AprobarAumentoAsync(Guid empleadoId, decimal nuevoSueldo)
{
    var empleado = await _context.Empleados
        .Where(e => e.Id == empleadoId)
        .ForceFirstOrDefaultAsync("Proceso de aprobaci√≥n");
    
    empleado.SueldoBase = nuevoSueldo; // Campo auditado
    
    // Guardado con comentario
    await _context.ForceSaveChangesAsync("Aumento aprobado por RRHH");
}

// Resultado en auditor√≠a:
// Comentario: "Aumento aprobado por RRHH"
```

### **Ejemplo 3: M√∫ltiples Campos Auditados**

```bash
# Marcar m√∫ltiples campos
python tools/entities/customvalidator.py empleado:SueldoBase:Auditar empleado:Bonificacion:Auditar
```

```csharp
// Un solo cambio puede auditar m√∫ltiples campos
empleado.SueldoBase = 5000;
empleado.Bonificacion = 800;
await _context.SaveChangesAsync();

// Resultado en auditor√≠a (un solo registro):
// ValorAnterior: {"SueldoBase": 3000, "Bonificacion": 200}
// NuevoValor: {"SueldoBase": 5000, "Bonificacion": 800}
```

---

## üöÄ Integraci√≥n con Force Operations

### **Compatibilidad Total**

El sistema de auditor√≠a se integra perfectamente con Force Operations:

```csharp
// Force SaveChanges con auditor√≠a
await _context.ForceSaveChangesAsync("Correcci√≥n autom√°tica de datos");

// Force Queries + SaveChanges auditado
var empleados = await _context.Empleados
    .ForceToListAsync("Consulta para proceso masivo");

empleado.SueldoBase = calcularNuevoSueldo();
await _context.ForceSaveChangesAsync("Actualizaci√≥n masiva de sueldos");
```

### **Ventajas de la Integraci√≥n**

- ‚úÖ **Contexto Completo**: Los comentarios Force aparecen en auditor√≠a
- ‚úÖ **Trazabilidad**: Se sabe exactamente por qu√© se hizo cada cambio
- ‚úÖ **Procesos Autom√°ticos**: Distingue cambios manuales de autom√°ticos
- ‚úÖ **Thread-Safe**: Cada operaci√≥n Force mantiene su comentario

---

## üìä Consulta y An√°lisis de Auditor√≠a

### **Consultas B√°sicas**

```sql
-- Ver todos los cambios de un empleado espec√≠fico
SELECT 
    a.Action,
    a.ValorAnterior,
    a.NuevoValor,
    a.Comentario,
    u.Nombre as UsuarioModificador,
    a.FechaCreacion
FROM system_auditoria a
JOIN system_users u ON a.CreadorId = u.Id
WHERE a.Tabla = 'Empleado' 
  AND a.RegistroId = '12345678-1234-1234-1234-123456789012'
ORDER BY a.FechaCreacion DESC;
```

### **An√°lisis de Campo Espec√≠fico**

```sql
-- Historial de cambios en SueldoBase
SELECT 
    JSON_VALUE(a.ValorAnterior, '$.SueldoBase') as SueldoAnterior,
    JSON_VALUE(a.NuevoValor, '$.SueldoBase') as SueldoNuevo,
    a.Comentario,
    a.FechaCreacion
FROM system_auditoria a
WHERE a.Tabla = 'Empleado'
  AND (
    JSON_VALUE(a.ValorAnterior, '$.SueldoBase') IS NOT NULL OR
    JSON_VALUE(a.NuevoValor, '$.SueldoBase') IS NOT NULL
  )
ORDER BY a.FechaCreacion DESC;
```

### **Reportes de Actividad**

```sql
-- Cambios por usuario en √∫ltimo mes
SELECT 
    u.Nombre,
    COUNT(*) as TotalCambios,
    COUNT(DISTINCT a.RegistroId) as RegistrosAfectados
FROM system_auditoria a
JOIN system_users u ON a.CreadorId = u.Id
WHERE a.FechaCreacion >= DATEADD(MONTH, -1, GETDATE())
GROUP BY u.Id, u.Nombre
ORDER BY TotalCambios DESC;
```

---

## üö® Troubleshooting

### **Problema: No se Crean Registros de Auditor√≠a**

```
Los campos marcados con [Auditar] no generan registros
```

**Soluci√≥n**: Verificar que el interceptor est√© registrado
```csharp
// En Program.cs debe estar:
services.AddEFInterceptors(connectionString);
```

### **Problema: Error de Serializaci√≥n JSON**

```
Error serializando valores para auditor√≠a
```

**Soluci√≥n**: Verificar que los campos auditados sean serializables
```csharp
// Evitar propiedades circulares o no serializables
[Auditar]
public string Campo { get; set; } // ‚úÖ OK

[Auditar]  
public ComplexObject Objeto { get; set; } // ‚ùå Puede fallar
```

### **Problema: Muchos Registros de Auditor√≠a**

```
La tabla system_auditoria crece muy r√°pido
```

**Soluci√≥n**: Ser selectivo con campos auditados
```csharp
// Solo auditar campos cr√≠ticos
[Auditar] public decimal SueldoBase { get; set; } // ‚úÖ Cr√≠tico

public DateTime UltimaModificacion { get; set; }   // ‚ùå No auditar
```

---

## üéØ Mejores Pr√°cticas

### **1. Campos a Auditar**

```csharp
// ‚úÖ Buenos candidatos para auditor√≠a
[Auditar] public decimal SueldoBase { get; set; }      // Datos financieros
[Auditar] public string NumeroDocumento { get; set; }  // Datos sensibles  
[Auditar] public bool Active { get; set; }             // Estado cr√≠tico

// ‚ùå Evitar auditar
public DateTime FechaModificacion { get; set; }        // Metadatos
public string UltimaActividad { get; set; }           // Datos frecuentes
public byte[] Imagen { get; set; }                    // Datos binarios
```

### **2. Usar Comentarios Descriptivos**

```csharp
// ‚úÖ Comentarios claros
await _context.ForceSaveChangesAsync("Aumento por promoci√≥n a supervisor");
await _context.ForceSaveChangesAsync("Correcci√≥n de error en n√≥mina mes anterior");
await _context.ForceSaveChangesAsync("Ajuste por inflaci√≥n 2024");

// ‚ùå Comentarios gen√©ricos
await _context.ForceSaveChangesAsync("Cambio");
await _context.ForceSaveChangesAsync("Update");
```

### **3. Consultas Eficientes**

```sql
-- ‚úÖ Usar √≠ndices apropiados
SELECT * FROM system_auditoria 
WHERE Tabla = 'Empleado' AND RegistroId = @empleadoId
ORDER BY FechaCreacion DESC;

-- ‚úÖ Filtrar por fechas para limitar resultados
SELECT * FROM system_auditoria 
WHERE FechaCreacion >= DATEADD(MONTH, -3, GETDATE());
```

### **4. Mantenimiento de Datos**

```sql
-- Script de limpieza peri√≥dica (ejecutar mensualmente)
DELETE FROM system_auditoria 
WHERE FechaCreacion < DATEADD(YEAR, -2, GETDATE())
  AND Tabla NOT IN ('Empleado', 'SystemUser'); -- Mantener auditor√≠a cr√≠tica
```

---

## üìà Consideraciones de Performance

- **Impacto M√≠nimo**: Solo procesa campos marcados con `[Auditar]`
- **Eficiencia**: Solo registra campos que realmente cambiaron
- **Transaccional**: Los registros de auditor√≠a se guardan en la misma transacci√≥n
- **Thread-Safe**: Cada request mantiene su contexto independiente
- **√çndices**: La tabla incluye √≠ndices optimizados para consultas frecuentes

---

## üîÑ Versionado y Migraci√≥n

### **Agregar Nuevos Campos Auditados**
1. Aplicar atributo `[Auditar]` usando la herramienta
2. Los cambios se registran autom√°ticamente desde la pr√≥xima modificaci√≥n

### **Quitar Auditor√≠a de un Campo**
1. Remover atributo `[Auditar]` del archivo .Metadata.cs
2. Los registros hist√≥ricos se mantienen intactos

### **Migrar Datos Existentes**
```sql
-- Los registros existentes no se auditan retroactivamente
-- Solo se auditan cambios futuros despu√©s de aplicar [Auditar]
```

---

**‚ú® El sistema de auditor√≠a es completamente transparente - solo marca campos con `[Auditar]` y todo funciona autom√°ticamente.**