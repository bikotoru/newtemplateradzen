# Sistema de Exportación a Excel - Documentación

## Resumen del Sistema

Sistema completo de **exportación a Excel** con **ClosedXML**, **formatos fuertemente tipados**, **configuración de columnas**, **títulos**, **filtros automáticos** y **propiedades de documento**. Integrado con el sistema de Query para exportar cualquier consulta.

## Arquitectura de Archivos

### Backend
- `Backend.Utils/Services/ExcelExportService.cs` - Servicio de exportación usando ClosedXML
- `Backend/Controllers/BaseQueryController.cs` - Endpoint `/export/excel`

### Frontend
- `Frontend/Services/BaseApiService.cs` - Método `ExportToExcelAsync()`

### Shared
- `Shared.Models/Export/ExcelFormat.cs` - Enum con formatos predefinidos
- `Shared.Models/Export/ExcelColumnConfig.cs` - Configuración de columnas
- `Shared.Models/Export/ExcelExportRequest.cs` - Request model para exportación
- `Shared.Models/Builders/ExcelExportBuilder.cs` - Builder fuertemente tipado

## Endpoint Disponible

### Exportación
- `POST /api/{entity}/export/excel` - Exporta datos a Excel

## Formatos Predefinidos (ExcelFormat)

### Fechas
```csharp
ExcelFormat.Date                 // "dd/MM/yyyy"
ExcelFormat.DateTime            // "dd/MM/yyyy HH:mm:ss"
ExcelFormat.DateTimeShort       // "dd/MM/yyyy HH:mm"
ExcelFormat.DateOnly            // "dd/MM/yyyy"
ExcelFormat.TimeOnly            // "HH:mm:ss"
```

### Números
```csharp
ExcelFormat.Integer             // "#,##0"
ExcelFormat.Decimal2            // "#,##0.00"
ExcelFormat.Decimal4            // "#,##0.0000"
ExcelFormat.Currency            // "$#,##0.00"
ExcelFormat.CurrencyNoSymbol    // "#,##0.00"
ExcelFormat.Percentage          // "0.00%"
ExcelFormat.Scientific          // "0.00E+00"
```

### Texto
```csharp
ExcelFormat.Text                // "@" (fuerza texto)
ExcelFormat.TextWrap            // "@" con wrap text
ExcelFormat.Phone               // Teléfono (texto)
ExcelFormat.Email               // Email (texto)
ExcelFormat.Url                 // URL (texto)
ExcelFormat.Guid                // GUID (texto)
ExcelFormat.Code                // Código (texto monospace)
```

### Booleanos
```csharp
ExcelFormat.YesNo               // "Sí"/"No"
ExcelFormat.TrueFalse           // "Verdadero"/"Falso"
ExcelFormat.ActiveInactive      // "Activo"/"Inactivo"
ExcelFormat.EnabledDisabled     // "Habilitado"/"Deshabilitado"
ExcelFormat.OnOff               // "Encendido"/"Apagado"
```

### Automático
```csharp
ExcelFormat.Auto                // Detecta automáticamente por tipo
```

## ExcelExportBuilder - Uso Básico

### 1. Exportación Simple con Detección Automática
```csharp
public async Task<byte[]> ExportarBasicoAsync()
{
    var exportRequest = new ExcelExportBuilder<Categoria>()
        .WithQuery(Query().Where(c => c.Active == true).ToQueryRequest())
        .WithColumn(c => c.Nombre, "Categoría")              // Auto: Text
        .WithColumn(c => c.Descripcion, "Descripción")       // Auto: Text  
        .WithColumn(c => c.FechaCreacion, "Fecha Creación")  // Auto: DateTime
        .WithColumn(c => c.Active, "Activa")                 // Auto: YesNo
        .Build();

    return await ExportToExcelAsync(exportRequest);
}
```

### 2. Exportación con Formatos Específicos
```csharp
public async Task<byte[]> ExportarConFormatosAsync()
{
    var exportRequest = new ExcelExportBuilder<Categoria>()
        .WithQuery(Query().Where(c => c.Active == true).ToQueryRequest())
        .WithColumn(c => c.Codigo, "Código", ExcelFormat.Code)
        .WithColumn(c => c.Nombre, "Categoría", ExcelFormat.Text)
        .WithColumn(c => c.FechaCreacion, "Fecha", ExcelFormat.Date)
        .WithColumn(c => c.Active, "Estado", ExcelFormat.ActiveInactive)
        .Build();

    return await ExportToExcelAsync(exportRequest);
}
```

### 3. Configuración Completa de Columnas
```csharp
public async Task<byte[]> ExportarCompletoAsync()
{
    var exportRequest = new ExcelExportBuilder<Categoria>()
        .WithQuery(Query().Include(c => c.Creador).ToQueryRequest())
        .WithColumn(c => c.Codigo, "Código", 
            format: ExcelFormat.Code,
            width: 15,
            alignment: ExcelAlignment.Center,
            backgroundColor: "#F0F0F0")
        .WithColumn(c => c.Nombre, "Categoría",
            format: ExcelFormat.Text,
            width: 25,
            bold: true)
        .WithColumn(c => c.Descripcion, "Descripción",
            format: ExcelFormat.TextWrap,
            width: 40,
            wrapText: true)
        .WithColumn(c => c.Creador.Nombre, "Usuario Creador")
        .WithColumn(c => c.FechaCreacion, "Fecha Creación", 
            ExcelFormat.DateTime,
            alignment: ExcelAlignment.Center)
        .Build();

    return await ExportToExcelAsync(exportRequest);
}
```

## Configuración de Documento

### 1. Títulos y Metadatos
```csharp
var exportRequest = new ExcelExportBuilder<Categoria>()
    .WithQuery(query)
    .WithColumn(c => c.Nombre, "Categoría")
    .WithTitle("Reporte de Categorías", "Exportación mensual")
    .WithSheetName("Categorias_2024")
    .WithDocumentProperties(
        title: "Reporte de Categorías",
        author: "Sistema de Gestión",
        company: "Mi Empresa",
        subject: "Datos de categorías activas",
        category: "Reportes",
        keywords: "categorias, reporte, excel"
    )
    .Build();
```

### 2. Opciones de Formato
```csharp
var exportRequest = new ExcelExportBuilder<Categoria>()
    .WithQuery(query)
    .WithColumn(c => c.Nombre, "Categoría")
    .WithFormatting(
        autoFilter: true,           // Filtros automáticos
        freezeHeaders: true,        // Congelar encabezados
        formatAsTable: true,        // Formato de tabla
        autoFitColumns: true,       // Ajuste automático de columnas
        tableStyleName: "TableStyleMedium2"  // Estilo de tabla
    )
    .WithMaxRows(1000)             // Máximo 1000 filas
    .Build();
```

## Funciones de Total

### 1. Totales por Columna
```csharp
var exportRequest = new ExcelExportBuilder<Producto>()
    .WithQuery(query)
    .WithColumn(p => p.Nombre, "Producto")
    .WithColumn(p => p.Precio, "Precio", ExcelFormat.Currency)
    .WithColumn(p => p.Cantidad, "Cantidad", ExcelFormat.Integer)
    .WithColumn(p => p.Total, "Total", ExcelFormat.Currency)
    .WithColumnTotal(p => p.Cantidad, ExcelTotalFunction.Sum)     // Suma de cantidades
    .WithColumnTotal(p => p.Total, ExcelTotalFunction.Sum)       // Suma de totales
    .Build();
```

### 2. Múltiples Funciones de Total
```csharp
var totales = new Dictionary<string, ExcelTotalFunction>
{
    { "Precio", ExcelTotalFunction.Average },    // Promedio de precios
    { "Cantidad", ExcelTotalFunction.Sum },      // Suma de cantidades
    { "Total", ExcelTotalFunction.Sum },         // Suma de totales
    { "Codigo", ExcelTotalFunction.Count }       // Conteo de registros
};

var exportRequest = new ExcelExportBuilder<Producto>()
    .WithQuery(query)
    .WithColumn(p => p.Codigo, "Código")
    .WithColumn(p => p.Precio, "Precio", ExcelFormat.Currency)
    .WithColumn(p => p.Cantidad, "Cantidad")
    .WithColumn(p => p.Total, "Total", ExcelFormat.Currency)
    .WithTotals(totales)
    .Build();
```

## Transformaciones Personalizadas

### 1. Transformación de Valores
```csharp
var exportRequest = new ExcelExportBuilder<Usuario>()
    .WithQuery(query)
    .WithColumn(u => u.Nombre, "Usuario")
    .WithColumnTransform(u => u.Activo, "Estado", 
        value => (bool)value ? "✅ Activo" : "❌ Inactivo")
    .WithColumnTransform(u => u.Email, "Email",
        value => value?.ToString()?.ToLowerInvariant() ?? "")
    .Build();
```

### 2. Formato Personalizado
```csharp
var exportRequest = new ExcelExportBuilder<Producto>()
    .WithQuery(query)
    .WithColumnCustomFormat(p => p.Codigo, "Código", "\"PRD-\"0000")
    .WithColumnCustomFormat(p => p.Precio, "Precio", "\"$\"#,##0.00\" USD\"")
    .Build();
```

## Integración con Queries Complejas

### 1. Exportar Resultados de Búsqueda
```csharp
public async Task<byte[]> ExportarBusquedaAsync(string termino, string clave)
{
    var query = Query()
        .Where(c => c.Clave == clave)
        .Include(c => c.Creador)
        .Search(termino)
        .InFields(c => c.Nombre, c => c.Descripcion);

    var exportRequest = new ExcelExportBuilder<Categoria>()
        .WithQuery(query.ToQueryRequest())
        .WithColumn(c => c.Nombre, "Categoría")
        .WithColumn(c => c.Descripcion, "Descripción")
        .WithColumn(c => c.Creador.Nombre, "Usuario")
        .WithTitle($"Búsqueda: {termino}", $"Filtrado por clave: {clave}")
        .Build();

    return await ExportToExcelAsync(exportRequest);
}
```

### 2. Exportar con Filtros Complejos
```csharp
public async Task<byte[]> ExportarConFiltrosAsync(DateTime fechaDesde, DateTime fechaHasta)
{
    var query = Query()
        .Where(c => c.FechaCreacion >= fechaDesde && c.FechaCreacion <= fechaHasta)
        .Where(c => c.Active == true)
        .Include(c => c.Creador)
        .OrderBy(c => c.FechaCreacion);

    var exportRequest = new ExcelExportBuilder<Categoria>()
        .WithQuery(query.ToQueryRequest())
        .WithColumn(c => c.Codigo, "Código")
        .WithColumn(c => c.Nombre, "Categoría")
        .WithColumn(c => c.FechaCreacion, "Fecha Creación", ExcelFormat.DateTime)
        .WithColumn(c => c.Creador.Nombre, "Creado por")
        .WithTitle("Reporte por Fechas", 
            $"Desde {fechaDesde:dd/MM/yyyy} hasta {fechaHasta:dd/MM/yyyy}")
        .Build();

    return await ExportToExcelAsync(exportRequest);
}
```

## Uso en Componentes Blazor

### 1. Descarga Automática con JavaScript (Recomendado)
```csharp
// En el component .razor.cs
@inject FileDownloadService FileDownloader

private async Task DescargarExcelAsync()
{
    try
    {
        loadingExport = true;
        
        // Descarga automática usando JavaScript
        await categoriaService.DescargarCategoriasExcelAsync(FileDownloader, soloActivas: true);
        
        // Mostrar mensaje de éxito
        await ShowMessage("Archivo descargado correctamente", MessageType.Success);
    }
    catch (Exception ex)
    {
        await ShowMessage($"Error descargando: {ex.Message}", MessageType.Error);
    }
    finally
    {
        loadingExport = false;
        StateHasChanged();
    }
}
```

### 2. Obtener Bytes para Manipulación Manual
```csharp
// En el component .razor.cs
private async Task ExportarDatosAsync()
{
    try
    {
        loadingExport = true;
        
        // Obtener bytes del Excel
        var excelBytes = await categoriaService.ExportarCategoriasExcelAsync(soloActivas: true);
        
        // Opción A: Usar FileDownloadService manualmente
        await FileDownloader.DownloadExcelAsync(excelBytes, "Categorias_Manual.xlsx");
        
        // Opción B: Enviar por email, subir a servidor, etc.
        await EnviarPorEmail(excelBytes, "reporte@empresa.com");
        
        // Opción C: Guardar en almacenamiento local
        await GuardarEnAlmacenamiento(excelBytes, "categorias_backup.xlsx");
        
        await ShowMessage("Procesado correctamente", MessageType.Success);
    }
    catch (Exception ex)
    {
        await ShowMessage($"Error procesando: {ex.Message}", MessageType.Error);
    }
    finally
    {
        loadingExport = false;
        StateHasChanged();
    }
}
```

### 2. Exportar con Parámetros del Usuario
```csharp
private async Task ExportarPersonalizadoAsync()
{
    var exportRequest = new ExcelExportBuilder<Categoria>()
        .WithQuery(
            Query()
                .Where(c => incluirInactivas || c.Active == true)
                .Include(c => c.Creador)
                .ToQueryRequest()
        )
        .WithColumn(c => c.Codigo, "Código")
        .WithColumn(c => c.Nombre, "Categoría")
        .WithColumn(c => c.Descripcion, "Descripción", wrapText: true)
        .WithColumn(c => c.FechaCreacion, "Fecha", ExcelFormat.Date)
        .WithTitle(tituloReporte, subtituloReporte)
        .WithFormatting(
            autoFilter: aplicarFiltros,
            formatAsTable: formatearComoTabla,
            freezeHeaders: congelarEncabezados
        )
        .WithMaxRows(maxFilas)
        .Build();

    var excelBytes = await ExportToExcelAsync(exportRequest);
    await DescargarArchivo(excelBytes, nombreArchivo);
}
```

## Detección Automática de Formatos

El sistema detecta automáticamente el formato basado en el tipo de propiedad:

```csharp
// Detección automática por tipo
DateTime -> ExcelFormat.DateTime
DateOnly -> ExcelFormat.Date
TimeOnly -> ExcelFormat.TimeOnly
decimal/double/float -> ExcelFormat.Decimal2
int/long/short/byte -> ExcelFormat.Integer
bool -> ExcelFormat.YesNo
Guid -> ExcelFormat.Guid
string (con "email" en nombre) -> ExcelFormat.Email
string (con "phone" en nombre) -> ExcelFormat.Phone
string (con "url" en nombre) -> ExcelFormat.Url
string -> ExcelFormat.Text
```

## Propiedades del Archivo Excel

### Configuración Completa
```csharp
.WithDocumentProperties(
    title: "Mi Reporte",
    subject: "Exportación de datos",
    author: "Sistema Automatizado",
    manager: "Gerente de TI",
    company: "Mi Empresa S.A.",
    category: "Reportes Operativos",
    keywords: "datos, excel, exportacion, automatico",
    comments: "Generado automáticamente por el sistema"
)
```

## Configuración del Sistema

### 1. Registrar FileDownloadService en Program.cs
```csharp
// En Program.cs (Blazor WebAssembly)
builder.Services.AddScoped<FileDownloadService>();
```

### 2. Incluir JavaScript en index.html
```html
<!-- En wwwroot/index.html -->
<script src="js/fileDownload.js"></script>
```

### 3. Configurar BaseQueryController (Backend)
```csharp
// En el constructor del controller específico
public CategoriaController(
    BaseQueryService<Categoria> service, 
    ILogger<CategoriaController> logger,
    IServiceProvider serviceProvider) 
    : base(service, logger, serviceProvider)
{
}
```

## Archivos del Sistema

### Frontend
- `Frontend/Services/FileDownloadService.cs` - Servicio de descarga con JS Interop
- `Frontend/wwwroot/js/fileDownload.js` - Funciones JavaScript de descarga

### JavaScript Functions Disponibles
```javascript
// Descargar desde Base64
window.downloadFileFromBase64(base64Data, fileName, mimeType)

// Descargar desde URL
window.downloadFileFromUrl(url, fileName)

// Descargar múltiples archivos
window.downloadMultipleFiles(files, delayMs)

// Abrir en nueva pestaña
window.openFileInNewTab(base64Data, mimeType)

// Mostrar diálogo guardar
window.showSaveDialog(base64Data, fileName, mimeType)
```

## Implementar en Nueva Entidad

### 1. Service Method
```csharp
public class MiEntidadService : BaseApiService<MiEntidad>
{
    // Automáticamente hereda ExportToExcelAsync()
    
    public async Task<byte[]> ExportarMiEntidadAsync()
    {
        var exportRequest = new ExcelExportBuilder<MiEntidad>()
            .WithQuery(Query().ToQueryRequest())
            .WithColumn(e => e.Nombre, "Nombre")
            .WithColumn(e => e.FechaCreacion, "Fecha", ExcelFormat.DateTime)
            .Build();

        return await ExportToExcelAsync(exportRequest);
    }
}
```

### 2. Component Usage
```csharp
// En el component
private async Task ExportarAsync()
{
    var excelBytes = await miEntidadService.ExportarMiEntidadAsync();
    await DescargarArchivo(excelBytes, "MiEntidad.xlsx");
}
```

**¡El sistema de exportación Excel está completo!** Incluye **formatos fuertemente tipados**, **detección automática**, **configuración avanzada**, **transformaciones personalizadas** y **integración completa** con el sistema de Query para exportar cualquier consulta a Excel profesional.