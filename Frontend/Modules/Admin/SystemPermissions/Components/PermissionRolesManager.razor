@using Shared.Models.DTOs.RolePermissions
@using Shared.Models.QueryModels
@using Shared.Models.Responses
@using Radzen
@using Radzen.Blazor

@* ========================================
   üõ°Ô∏è PERMISSION ROLES MANAGER
   Componente para gestionar roles que tienen un permiso
   ======================================== *@

<RadzenStack Gap="1rem">
    
    @* Mensaje de solo lectura *@
    @if (!CanEdit)
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
            <RadzenIcon Icon="visibility" Style="margin-right: 8px;" />
            Est√°s viendo los roles en modo solo lectura. Necesitas permisos de edici√≥n para realizar cambios.
        </RadzenAlert>
    }

    <RadzenCard class="rz-shadow-0" Style="border: 1px solid var(--rz-border-color);">
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Gap="1rem" Wrap="FlexWrap.Wrap">
            
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" Wrap="FlexWrap.Wrap">
                <RadzenFormField Text="Buscar roles" Variant="Variant.Outlined">
                    <Start>
                        <RadzenIcon Icon="search" />
                    </Start>
                    <ChildContent>
                        <RadzenTextBox @bind-Value="searchTerm" 
                                       Placeholder="Escriba para buscar..." 
                                       @oninput="OnSearchChanged"
                                       Style="width: 280px;" />
                    </ChildContent>
                </RadzenFormField>
                
                <RadzenCheckBox @bind-Value="showOnlyWithPermission" 
                               Name="showOnlyWithPermission"
                               TValue="bool"
                               Change="@OnShowOnlyWithPermissionChanged" />
                <RadzenLabel Text="Solo roles con el permiso" Component="showOnlyWithPermission" Style="margin-left: 8px; font-weight: 500;" />
            </RadzenStack>
            
            <RadzenButton Text="Asignar a Rol" 
                         Icon="group_add" 
                         ButtonStyle="ButtonStyle.Success"
                         Variant="Variant.Filled"
                         Size="ButtonSize.Medium"
                         Click="ShowAddRoleModal"
                         Disabled="@(!CanEdit || isLoading)"
                         Shade="Shade.Dark" />
        </RadzenStack>
    </RadzenCard>

    @* Loading state *@
    @if (isLoading)
    {
        <RadzenCard>
            <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="1rem" Style="padding: 2rem;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body1" Style="color: var(--rz-text-secondary-color);">
                    Cargando roles...
                </RadzenText>
            </RadzenStack>
        </RadzenCard>
    }
    else if (errorMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
            <RadzenIcon Icon="error" Style="margin-right: 8px;" />
            @errorMessage
        </RadzenAlert>
    }
    else
    {
        @* Lista de roles *@
        @if (permissionRoles?.Any() == true)
        {
            <RadzenStack Gap="0.5rem">
                @foreach (var role in permissionRoles)
                {
                    <RadzenCard Variant="Variant.Outlined" 
                               class="@($"role-item {(role.HasPermission ? "role-with-permission" : "role-without-permission")}")"
                               Style="@GetRoleItemStyle(role)">
                        <RadzenRow AlignItems="AlignItems.Center" Gap="1rem">
                            
                            @* Icono y nombre del rol *@
                            <RadzenColumn SizeXS="8">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem">
                                    <RadzenIcon Icon="group" Style="font-size: 2.5rem; color: var(--rz-primary);" />
                                    <RadzenStack Gap="0.25rem">
                                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-weight: 600; margin: 0;">
                                            @role.Nombre
                                        </RadzenText>
                                        @if (!string.IsNullOrEmpty(role.Descripcion))
                                        {
                                            <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color); margin: 0;">
                                                @role.Descripcion
                                            </RadzenText>
                                        }
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-disabled-color); margin: 0;">
                                                ID: @role.RoleId
                                            </RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-disabled-color); margin: 0;">
                                                üë• @role.UsersCount usuarios
                                            </RadzenText>
                                            @if (!role.Active)
                                            {
                                                <RadzenBadge Text="Inactivo" 
                                                           BadgeStyle="BadgeStyle.Secondary" 
                                                           Variant="Variant.Outlined" />
                                            }
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenColumn>

                            @* Estado y acciones *@
                            <RadzenColumn SizeXS="4" Style="text-align: right;">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" JustifyContent="JustifyContent.End">
                                    @if (role.HasPermission)
                                    {
                                        <RadzenBadge Text="Asignado" 
                                                   BadgeStyle="BadgeStyle.Success" 
                                                   Variant="Variant.Filled" />
                                        
                                        <RadzenButton Icon="group_remove" 
                                                     ButtonStyle="ButtonStyle.Danger"
                                                     Variant="Variant.Outlined"
                                                     Size="ButtonSize.Small"
                                                     Click="@(() => ShowRemovePermissionModal(role))"
                                                     Disabled="@(!CanEdit)"
                                                     title="Remover permiso del rol" />
                                    }
                                    else
                                    {
                                        <RadzenBadge Text="Sin permiso" 
                                                   BadgeStyle="BadgeStyle.Light" 
                                                   Variant="Variant.Outlined" />
                                        
                                        <RadzenButton Icon="group_add" 
                                                     ButtonStyle="ButtonStyle.Success"
                                                     Variant="Variant.Outlined"
                                                     Size="ButtonSize.Small"
                                                     Click="@(() => ShowAssignPermissionModal(role))"
                                                     Disabled="@(!CanEdit)"
                                                     title="Asignar permiso al rol" />
                                    }
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenCard>
                }
            </RadzenStack>
        }
        else
        {
            @if (showOnlyWithPermission)
            {
                <RadzenCard>
                    <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="1.5rem" Style="padding: 3rem;">
                        <RadzenIcon Icon="group_add" Style="font-size: 4rem; color: var(--rz-primary-light);" />
                        <RadzenText TextStyle="TextStyle.H6" Style="color: var(--rz-text-secondary-color); text-align: center;">
                            No hay roles con este permiso
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-disabled-color); text-align: center; max-width: 400px;">
                            Haz clic en "Asignar a Rol" para empezar a asignar este permiso a roles
                        </RadzenText>
                        @if (CanEdit)
                        {
                            <RadzenButton Text="Asignar a Rol" 
                                         Icon="group_add" 
                                         ButtonStyle="ButtonStyle.Success"
                                         Variant="Variant.Filled"
                                         Size="ButtonSize.Medium"
                                         Click="ShowAddRoleModal"
                                         Style="margin-top: 1rem;" />
                        }
                    </RadzenStack>
                </RadzenCard>
            }
            else
            {
                <RadzenCard>
                    <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="1rem" Style="padding: 3rem;">
                        <RadzenIcon Icon="search_off" Style="font-size: 4rem; color: var(--rz-text-disabled-color);" />
                        <RadzenText TextStyle="TextStyle.H6" Style="color: var(--rz-text-secondary-color); text-align: center;">
                            No se encontraron roles con los criterios de b√∫squeda
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-disabled-color); text-align: center;">
                            Intenta modificar los filtros o el t√©rmino de b√∫squeda
                        </RadzenText>
                    </RadzenStack>
                </RadzenCard>
            }
        }

        @* Paginaci√≥n *@
        @if (pagedResult != null && pagedResult.TotalCount > pageSize)
        {
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Style="margin-top: 2rem;">
                <RadzenPager Count="@totalPages" 
                            Page="@currentPage" 
                            PageChanged="@(async (args) => await OnPageChanged(args.PageIndex + 1))"
                            ShowPagingSummary="true"
                            PagingSummaryFormat="Mostrando p√°gina {0} de {1} ({2} roles en total)" />
            </RadzenStack>
        }
    }
</RadzenStack>

<style>
    .role-item {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .role-with-permission {
        background: linear-gradient(145deg, var(--rz-success-lighter), var(--rz-base-50));
        border-color: var(--rz-success-light);
    }
    
    .role-without-permission {
        background: var(--rz-base-50);
    }
    
    .role-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
</style>