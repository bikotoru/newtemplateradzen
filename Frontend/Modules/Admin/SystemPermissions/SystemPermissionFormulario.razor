@page "/admin/systempermission/formulario"
@page "/admin/systempermission/formulario/{Id:guid}"
@using Frontend.Components.Base.Forms.PageWithCommandBar
@using Frontend.Components.Base
@using Frontend.Components.Validation
@using Shared.Models.Entities
@inherits AuthorizedPageBase
@attribute [AuthorizePermission("SYSTEMPERMISSION.VIEW", "SYSTEMPERMISSION.CREATE", "SYSTEMPERMISSION.EDIT")]

<PageTitle>@(isEditMode ? $"Editar SystemPermission - {entity?.Nombre}" : "Nuevo SystemPermission")</PageTitle>

@if (HasRequiredPermissions && !IsCheckingPermissions)
{
    <PageWithCommandBar BackPath="/admin/systempermission/list" 
                        ShowSave="@CanSave"
                        OnSaveClick="@SaveForm">

    <div class="full-width-tabs">
        <CrmTabs DefaultTabId="tab1" DisableUrlSync="true">
            
            <CrmTab Id="tab1" Title="Informaci칩n General" Icon="edit" IconColor="#0078d4">
                <div class="scrollable-content">
                    <RadzenRow JustifyContent="JustifyContent.Center">
                        <RadzenColumn SizeLG="4" SizeMD="6" SizeSM="12">
                            
                            <EssentialsCard Title="@(isEditMode ? "Editar SystemPermission" : "Nuevo SystemPermission")" 
                                           Icon="@(isEditMode ? "edit" : "add")" 
                                           IconColor="#0078d4"
                                           ShowEssentials=@(entity.Id != Guid.Empty)>
                             
                                <EssentialsTemplate>
                                    <EssentialsGrid>
                                        <EssentialsItem Label="Estado" Value="@(entity.Active ? "Activo" : "Inactivo")" />
                                        <EssentialsItem Label="Creado" Value="@(entity.FechaCreacion.ToString("dd/MM/yyyy"))" />
                                        <EssentialsItem Label="ID" Value="@entity.Id.ToString()" />
                                    </EssentialsGrid>
                                </EssentialsTemplate>
                                
                                <ChildContent>
                                    @if (entity != null)
                                    {
                                        <FormValidator Entity="entity" Rules="@GetValidationRules()">
                                            
                                            <RadzenStack Gap="1rem">
                                                <ValidatedInput FieldName="Nombre" Value="@entity.Nombre">
                                                    <RadzenFormField Text="Action Key / Nombre" Style="width: 100%">
                                                        <RadzenTextBox @bind-Value="entity.Nombre" 
                                                                       @oninput="OnActionKeyChanged"
                                                                       Placeholder="Ej: CATEGORIA.CREAR, USUARIO.EDITAR"
                                                                       Disabled="@(!CanEdit)" />
                                                    @if (actionKeyValidationState == ActionKeyValidationState.Checking)
                                                    {
                                                        <div class="validation-checking">
                                                            <RadzenIcon Icon="sync" Style="animation: spin 1s linear infinite; color: #0078d4;" />
                                                            <span style="margin-left: 8px; color: #0078d4;">Verificando disponibilidad...</span>
                                                        </div>
                                                    }
                                                    else if (actionKeyValidationState == ActionKeyValidationState.Invalid)
                                                    {
                                                        <div class="validation-error">
                                                            <RadzenIcon Icon="error" Style="color: #d13438;" />
                                                            <span style="margin-left: 8px; color: #d13438;">Este Action Key ya existe</span>
                                                        </div>
                                                    }
                                                    else if (actionKeyValidationState == ActionKeyValidationState.Valid && !string.IsNullOrWhiteSpace(entity.Nombre))
                                                    {
                                                        <div class="validation-success">
                                                            <RadzenIcon Icon="check_circle" Style="color: #107c10;" />
                                                            <span style="margin-left: 8px; color: #107c10;">Action Key disponible</span>
                                                        </div>
                                                    }
                                                </RadzenFormField>
                                            </ValidatedInput>

                                                <ValidatedInput FieldName="GrupoNombre" Value="@entity.GrupoNombre">
                                                    <RadzenFormField Text="Grupo (Opcional)" Style="width: 100%">
                                                        <RadzenDropDown @bind-Value="entity.GrupoNombre"
                                                                        Data="@gruposExistentes"
                                                                        AllowClear="true"
                                                                        AllowFiltering="true"
                                                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                                                        Placeholder="Selecciona grupo existente o escribe nuevo"
                                                                        Style="width: 100%"
                                                                        LoadingText="Cargando grupos..."
                                                                        Disabled="@(!CanEdit)">
                                                            <Template Context="grupo">
                                                                @grupo
                                                            </Template>
                                                        </RadzenDropDown>
                                                    </RadzenFormField>
                                                </ValidatedInput>
                                            
                                                <ValidatedInput FieldName="Descripcion" Value="@entity.Descripcion">
                                                    <RadzenFormField Text="Descripci칩n (Opcional)" Style="width: 100%">
                                                        <RadzenTextArea @bind-Value="entity.Descripcion"
                                                                        Placeholder="Descripci칩n del permiso (opcional)" 
                                                                        Rows="3"
                                                                        Style="width: 100%"
                                                                        Disabled="@(!CanEdit)" />
                                                    </RadzenFormField>
                                                </ValidatedInput>
                                                
                                            </RadzenStack>
                                            
                                        </FormValidator>
                                    }
                                </ChildContent>
                            </EssentialsCard>
                            
                        </RadzenColumn>
                    </RadzenRow>
                </div>
            </CrmTab>
            
        </CrmTabs>
    </div>

    </PageWithCommandBar>

    @if (!CanEdit)
    {
        <div class="read-only-notice">
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                <RadzenIcon Icon="visibility" /> Est치s viendo este registro en modo solo lectura. 
                @if (isEditMode)
                {
                    <text>Necesitas el permiso "SYSTEMPERMISSION.EDIT" para modificarlo.</text>
                }
                else
                {
                    <text>Necesitas el permiso "SYSTEMPERMISSION.CREATE" para crear registros.</text>
                }
            </RadzenAlert>
        </div>
    }
}

<style>
    .read-only-notice {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1000;
        max-width: 400px;
        animation: slideInRight 0.3s ease-out;
    }

    @@keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @@media (max-width: 768px) {
        .read-only-notice {
            position: relative;
            top: auto;
            right: auto;
            margin: 1rem;
            max-width: none;
        }
    }
</style>