@page "/admin/systemuser/formulario"
@page "/admin/systemuser/formulario/{Id:guid}"
@using Frontend.Components.Base.Forms.PageWithCommandBar
@using Frontend.Components.Base
@using Frontend.Components.Validation
@using Shared.Models.Entities
@using Frontend.Modules.Admin.SystemUsers.Components
@inherits AuthorizedPageBase
@attribute [AuthorizePermission("SYSTEMUSER.VIEW", "SYSTEMUSER.CREATE", "SYSTEMUSER.UPDATE")]

<PageTitle>@(isEditMode ? $"Editar SystemUser - {entity?.Nombre}" : "Nuevo SystemUser")</PageTitle>

@if (HasRequiredPermissions && !IsCheckingPermissions)
{
    <PageWithCommandBar BackPath="/admin/systemuser/list" 
                        ShowSave="@CanSave"
                        OnSaveClick="@SaveForm">

        <div class="full-width-tabs">
            <CrmTabs DefaultTabId="tab1" DisableUrlSync="true">
                
                <CrmTab Id="tab1" Title="Información General" Icon="edit" IconColor="#0078d4">
                    <div class="scrollable-content">
                        <RadzenRow JustifyContent="JustifyContent.Center">
                            <RadzenColumn SizeLG="4" SizeMD="6" SizeSM="12">
                                
                                <EssentialsCard Title="@(isEditMode ? "Editar SystemUser" : "Nuevo SystemUser")" 
                                               Icon="@(isEditMode ? "edit" : "add")" 
                                               IconColor="#0078d4"
                                               ShowEssentials=@(entity?.Id != Guid.Empty)>
                                 
                                    <EssentialsTemplate>
                                        <EssentialsGrid>
                                            <EssentialsItem Label="Estado" Value="@(entity?.Active == true ? "Activo" : "Inactivo")" />
                                            <EssentialsItem Label="Creado" Value="@(entity?.FechaCreacion.ToString("dd/MM/yyyy") ?? "")" />
                                            <EssentialsItem Label="ID" Value="@(entity?.Id.ToString() ?? "")" />
                                        </EssentialsGrid>
                                    </EssentialsTemplate>
                                    
                                    <ChildContent>
                                        @if (entity != null)
                                        {
                                            <FormValidator Entity="entity" Rules="@GetValidationRules()">
                                                
                                                <RadzenStack Gap="1rem">
                                                    <ValidatedInput FieldName="Nombre" Value="@entity.Nombre">
                                                        <RadzenFormField Text="Nombre" Style="width: 100%">
                                                            <RadzenTextBox @oninput="@(v => entity.Nombre = v.Value?.ToString())" 
                                                                           Value="@entity.Nombre"
                                                                           Placeholder="Ingrese nombre"
                                                                           Disabled="@(!CanEdit)" />
                                                        </RadzenFormField>
                                                    </ValidatedInput>
                                                  
                                                    
                                                </RadzenStack>
                                                
                                            </FormValidator>
                                        }
                                    </ChildContent>
                                </EssentialsCard>
                                
                            </RadzenColumn>
                        </RadzenRow>
                    </div>
                </CrmTab>
                
                @if (isEditMode && entity != null && entity.Id != Guid.Empty)
                {
                    <CrmTab Id="tab2" Title="Gestión de Permisos" Icon="security" IconColor="#28a745">
                        <div class="scrollable-content">
                            <RadzenRow JustifyContent="JustifyContent.Center">
                                <RadzenColumn SizeLG="12" SizeMD="12" SizeSM="12">
                                    <SystemUserPermissionsManager UserId="@entity.Id" UserName="@entity.Nombre" CanEdit="@CanEdit" />
                                </RadzenColumn>
                            </RadzenRow>
                        </div>
                    </CrmTab>
                    
                    <CrmTab Id="tab3" Title="Gestión de Roles" Icon="group" IconColor="#007bff">
                        <div class="scrollable-content">
                            <RadzenRow JustifyContent="JustifyContent.Center">
                                <RadzenColumn SizeLG="12" SizeMD="12" SizeSM="12">
                                    <SystemUserRolesManager UserId="@entity.Id" UserName="@entity.Nombre" CanEdit="@CanEdit" />
                                </RadzenColumn>
                            </RadzenRow>
                        </div>
                    </CrmTab>
                }
                
            </CrmTabs>
        </div>

    </PageWithCommandBar>

}

