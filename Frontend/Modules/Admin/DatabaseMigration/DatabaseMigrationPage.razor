@page "/admin/database-migration"
@using Frontend.Services
@inject API Api
@inject ILogger<DatabaseMigrationPage> Logger

<PageTitle>Migraci√≥n de Base de Datos</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <RadzenCard>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>üîß Migraci√≥n de Base de Datos</h4>
                    <RadzenBadge BadgeStyle="@(_migrationExecuted ? BadgeStyle.Success : BadgeStyle.Warning)"
                                Text="@(_migrationExecuted ? "Migraci√≥n Ejecutada" : "Migraci√≥n Pendiente")" />
                </div>

                @if (!string.IsNullOrEmpty(_statusMessage))
                {
                    <RadzenAlert AlertStyle="@_alertStyle" Variant="Variant.Flat" Shade="Shade.Lighter" class="mb-3">
                        @_statusMessage
                    </RadzenAlert>
                }

                <div class="row">
                    <div class="col-md-6">
                        <RadzenCard>
                            <h5>üìã Estado de Migraci√≥n</h5>
                            <div class="mt-3">
                                <RadzenButton Text="Verificar Estado"
                                             Icon="refresh"
                                             ButtonStyle="ButtonStyle.Secondary"
                                             Click="CheckMigrationStatus"
                                             IsBusy="_checking" />
                            </div>

                            @if (!string.IsNullOrEmpty(_constraintDefinition))
                            {
                                <div class="mt-3">
                                    <h6>Definici√≥n del Constraint:</h6>
                                    <RadzenCard class="mt-2">
                                        <code style="font-size: 0.8rem;">@_constraintDefinition</code>
                                    </RadzenCard>
                                </div>
                            }
                        </RadzenCard>
                    </div>

                    <div class="col-md-6">
                        <RadzenCard>
                            <h5>‚ö° Ejecutar Migraci√≥n</h5>
                            <p class="text-muted">
                                Esta migraci√≥n agregar√° los tipos de campos de referencia:
                                <strong>entity_reference</strong>, <strong>user_reference</strong>, <strong>file_reference</strong>
                            </p>

                            <div class="mt-3">
                                <RadzenButton Text="Ejecutar Migraci√≥n"
                                             Icon="upgrade"
                                             ButtonStyle="ButtonStyle.Primary"
                                             Click="ExecuteMigration"
                                             IsBusy="_executing"
                                             Disabled="_migrationExecuted" />
                            </div>
                        </RadzenCard>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <RadzenCard>
                            <h5>üß™ Prueba de Campos de Referencia</h5>
                            <p class="text-muted">
                                Despu√©s de ejecutar la migraci√≥n, puedes probar crear un campo de referencia.
                            </p>

                            <div class="row">
                                <div class="col-md-3">
                                    <RadzenFormField Text="Entidad:" class="w-100">
                                        <RadzenTextBox @bind-Value="_testEntityName" Placeholder="Ej: TestEntity" class="w-100" />
                                    </RadzenFormField>
                                </div>
                                <div class="col-md-3">
                                    <RadzenFormField Text="Campo:" class="w-100">
                                        <RadzenTextBox @bind-Value="_testFieldName" Placeholder="Ej: TestField" class="w-100" />
                                    </RadzenFormField>
                                </div>
                                <div class="col-md-3">
                                    <RadzenFormField Text="Tipo:" class="w-100">
                                        <RadzenDropDown @bind-Value="_testFieldType"
                                                       Data="@_fieldTypes"
                                                       TextProperty="Text"
                                                       ValueProperty="Value"
                                                       class="w-100" />
                                    </RadzenFormField>
                                </div>
                                <div class="col-md-3">
                                    <div style="padding-top: 1.5rem;">
                                        <RadzenButton Text="Probar"
                                                     Icon="science"
                                                     ButtonStyle="ButtonStyle.Success"
                                                     Click="TestFieldCreation"
                                                     IsBusy="_testing"
                                                     Disabled="!_migrationExecuted" />
                                    </div>
                                </div>
                            </div>
                        </RadzenCard>
                    </div>
                </div>
            </RadzenCard>
        </div>
    </div>
</div>