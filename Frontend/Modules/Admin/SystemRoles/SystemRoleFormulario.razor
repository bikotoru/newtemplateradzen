@page "/admin/systemrole/formulario"
@page "/admin/systemrole/formulario/{Id:guid}"
@using Frontend.Components.Base.Forms.PageWithCommandBar
@using Frontend.Components.Base
@using Frontend.Components.Validation
@using Frontend.Modules.Admin.SystemRoles.Components
@using Shared.Models.Entities
@inherits AuthorizedPageBase
@attribute [AuthorizePermission("SYSTEMROLE.VIEW", "SYSTEMROLE.CREATE", "SYSTEMROLE.UPDATE")]

<PageTitle>@(isEditMode ? $"Editar SystemRole - {entity?.Nombre}" : "Nuevo SystemRole")</PageTitle>

@if (HasRequiredPermissions && !IsCheckingPermissions)
{
    <PageWithCommandBar BackPath="/admin/systemrole/list" 
                        ShowSave="@CanSave"
                        OnSaveClick="@SaveForm">

    <div class="full-width-tabs">
        <CrmTabs DefaultTabId="tab1" DisableUrlSync="true">
            
            <CrmTab Id="tab1" Title="Información General" Icon="edit" IconColor="#0078d4">
                <div class="scrollable-content">
                    <RadzenRow JustifyContent="JustifyContent.Center">
                        <RadzenColumn SizeLG="4" SizeMD="6" SizeSM="12">
                            
                            <EssentialsCard Title="@(isEditMode ? "Editar SystemRole" : "Nuevo SystemRole")" 
                                           Icon="@(isEditMode ? "edit" : "add")" 
                                           IconColor="#0078d4"
                                           ShowEssentials=@(entity?.Id != Guid.Empty)>
                             
                                <EssentialsTemplate>
                                    <EssentialsGrid>
                                        <EssentialsItem Label="Estado" Value="@(entity?.Active == true ? "Activo" : "Inactivo")" />
                                        <EssentialsItem Label="Creado" Value="@(entity?.FechaCreacion.ToString("dd/MM/yyyy") ?? "-")" />
                                        <EssentialsItem Label="ID" Value="@(entity?.Id.ToString() ?? "-")" />
                                    </EssentialsGrid>
                                </EssentialsTemplate>
                                
                                <ChildContent>
                                    @if (entity != null)
                                    {
                                        <FormValidator Entity="entity" Rules="@GetValidationRules()">
                                            
                                            <RadzenStack Gap="1rem">
                                                <ValidatedInput FieldName="Nombre" Value="@entity.Nombre">
                                                    <RadzenFormField Text="Nombre del Rol" Style="width: 100%">
                                                        <RadzenTextBox @oninput="@(v => entity.Nombre = v.Value?.ToString())" 
                                                                       Value="@entity.Nombre"
                                                                       Placeholder="Ej: Administrador, Usuario, Supervisor..."
                                                                       Disabled="@(!CanEdit)" />
                                                    </RadzenFormField>
                                                </ValidatedInput>
                                                
                                                <ValidatedInput FieldName="TypeRole" Value="@entity.TypeRole">
                                                    <RadzenFormField Text="Tipo de Rol" Style="width: 100%">
                                                        <RadzenDropDown @bind-Value="@entity.TypeRole"
                                                                        Data="@GetRoleTypes()"
                                                                        Style="width: 100%"
                                                                        Placeholder="Seleccionar tipo de rol"
                                                                        Disabled="@(!CanEdit)">
                                                            <Template Context="item">
                                                                <div class="d-flex align-items-center">
                                                                    <span class="badge @(item == "Admin" ? "badge-danger" : "badge-primary") me-2">
                                                                        @item
                                                                    </span>
                                                                    <span>
                                                                        @(item == "Admin" ? "Administrador del sistema" : "Acceso estándar")
                                                                    </span>
                                                                </div>
                                                            </Template>
                                                        </RadzenDropDown>
                                                    </RadzenFormField>
                                                </ValidatedInput>
                                                
                                                <ValidatedInput FieldName="Descripcion" Value="@entity.Descripcion">
                                                    <RadzenFormField Text="Descripción (Opcional)" Style="width: 100%">
                                                        <RadzenTextArea @oninput="@(v => entity.Descripcion = v.Value?.ToString())" 
                                                                        Value="@entity.Descripcion"
                                                                        Placeholder="Describe el propósito y alcance de este rol..." 
                                                                        Rows="3"
                                                                        Disabled="@(!CanEdit)" />
                                                    </RadzenFormField>
                                                </ValidatedInput>
                                            
                                            @if (entity?.TypeRole == "Admin")
                                            {
                                                <RadzenAlert AlertStyle="AlertStyle.Warning" Icon="warning" Size="AlertSize.Small">
                                                    <strong>¡Atención!</strong> Los roles de tipo Admin tienen acceso completo al sistema. Asigna solo a usuarios de confianza.
                                                </RadzenAlert>
                                            }
                                            else if (entity?.TypeRole == "Access")
                                            {
                                                <RadzenAlert AlertStyle="AlertStyle.Info" Icon="info" Size="AlertSize.Small">
                                                    <strong>Rol de Acceso:</strong> Este tipo de rol permite configurar permisos específicos según las necesidades del usuario.
                                                </RadzenAlert>
                                            }
                                                
                                            </RadzenStack>
                                            
                                        </FormValidator>
                                    }
                                </ChildContent>
                            </EssentialsCard>
                            
                        </RadzenColumn>
                    </RadzenRow>
                </div>
            </CrmTab>

            @if (isEditMode && entity != null && AuthService.HasPermission("SYSTEMROLE.MANAGEPERMISSIONS"))
            {
                <CrmTab Id="tab2" Title="Gestión de Permisos" Icon="security" IconColor="#28a745">
                    <div class="scrollable-content p-3">
                        <SystemRolePermissionsManager RoleId="@entity.Id" 
                                                     RoleName="@entity.Nombre"
                                                     CanEdit="@CanEdit"
                                                     OnPermissionsUpdated="@OnPermissionsUpdated" />
                    </div>
                </CrmTab>
            }
            
            @if (isEditMode && entity != null && AuthService.HasPermission("SYSTEMROLE.MANAGEUSERS"))
            {
                <CrmTab Id="tab3" Title="Gestión de Usuarios" Icon="group" IconColor="#007bff">
                    <div class="scrollable-content p-3">
                        <SystemRoleUsersManager RoleId="@entity.Id" 
                                               RoleName="@entity.Nombre"
                                               CanEdit="@CanEdit" />
                    </div>
                </CrmTab>
            }
            
        </CrmTabs>
    </div>

    </PageWithCommandBar>

}