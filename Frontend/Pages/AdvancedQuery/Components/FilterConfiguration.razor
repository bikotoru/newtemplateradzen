@using Radzen.Blazor
@using Frontend.Components.CustomRadzen.QueryBuilder
@using Frontend.Components.CustomRadzen.QueryBuilder.Models
@using Frontend.Components.CustomRadzen.QueryBuilder.Extensions
@using LogicalFilterOperator = Frontend.Components.CustomRadzen.QueryBuilder.Models.LogicalFilterOperator
@using FilterCaseSensitivity = Frontend.Components.CustomRadzen.QueryBuilder.Models.FilterCaseSensitivity
@implements IDisposable

@if (!string.IsNullOrEmpty(SelectedEntityName) && EntityFields.Any())
{
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenStack Gap="1rem">
                    <RadzenText TextStyle="TextStyle.H6">
                        <RadzenIcon Icon="@(IsReadOnly ? "visibility" : "filter_alt")" class="rz-me-2" />
                        2. @(IsReadOnly ? "Configurar Filtros (Solo Lectura)" : "Configurar Filtros")
                    </RadzenText>

                    @if (IsReadOnly)
                    {
                        <!-- Read-only view showing filter configuration -->
                        @if (HasConfiguredFilters())
                        {
                            <div class="rz-border rz-border-radius-medium rz-p-3" style="background-color: var(--rz-background-color);">
                                <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-2">Filtros configurados:</RadzenText>
                                @if (ReadOnlyFilters != null && ReadOnlyFilters.Any())
                                {
                                    @foreach (var filter in ReadOnlyFilters)
                                    {
                                        <div class="rz-display-flex rz-align-items-center rz-gap-2 rz-mb-2">
                                            <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="@filter.PropertyName" />
                                            <RadzenText class="rz-color-secondary">@GetOperatorText(filter.Operator)</RadzenText>
                                            @if (filter.Value != null)
                                            {
                                                <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@filter.Value.ToString()" />
                                            }
                                            @if (filter != ReadOnlyFilters.Last())
                                            {
                                                <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@filter.LogicalOperator" />
                                            }
                                        </div>
                                    }
                                }
                            </div>
                            
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="2rem" class="rz-p-3" Style="background-color: var(--rz-primary-lighter); border-radius: 8px;">
                                <div>
                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-color-secondary">Operador L칩gico:</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body1">@GetLogicalOperatorText()</RadzenText>
                                </div>
                                <div>
                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-color-secondary">L칤mite de Registros:</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body1">@TakeLimit registros</RadzenText>
                                </div>
                            </RadzenStack>
                            
                            <!-- Execute Button in Read-Only mode -->
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.Center">
                                <RadzenButton Text="Ejecutar Consulta"
                                            Icon="play_arrow"
                                            ButtonStyle="ButtonStyle.Success"
                                            Size="ButtonSize.Medium"
                                            Click="@OnExecuteQueryClick"
                                            Disabled="@IsLoading" />
                            </RadzenStack>
                        }
                        else
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true">
                                <strong>Sin filtros:</strong> Esta b칰squeda no tiene filtros configurados.
                            </RadzenAlert>
                            
                            <!-- Execute Button even without filters -->
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.Center">
                                <RadzenButton Text="Ejecutar Consulta"
                                            Icon="play_arrow"
                                            ButtonStyle="ButtonStyle.Success"
                                            Size="ButtonSize.Medium"
                                            Click="@OnExecuteQueryClick"
                                            Disabled="@IsLoading" />
                            </RadzenStack>
                        }
                    }
                    else
                    {
                        <!-- Editable view - original content -->
                        <!-- Configuraci칩n Global del Filtro -->
                        <RadzenRow>
                            <RadzenColumn Size="6">
                                <RadzenLabel Text="Operador L칩gico Principal:" />
                                <RadzenSelectBar @bind-Value="LogicalOperator" TValue="LogicalFilterOperator">
                                    <Items>
                                        <RadzenSelectBarItem Text="Y (AND)" Value="LogicalFilterOperator.And" />
                                        <RadzenSelectBarItem Text="O (OR)" Value="LogicalFilterOperator.Or" />
                                    </Items>
                                </RadzenSelectBar>
                            </RadzenColumn>
                            <RadzenColumn Size="6">
                                <RadzenLabel Text="L칤mite de Resultados:" />
                                <RadzenNumeric @bind-Value="TakeLimit" Min="1" Max="1000" Style="width: 100%;" />
                            </RadzenColumn>
                        </RadzenRow>

                        <!-- CustomDataFilter -->
                        <div @onclick="@RefreshFilterState" @onclick:stopPropagation="false">
                        <CustomDataFilter @ref="dataFilterRef"
                                        TItem="object"
                                        LogicalFilterOperator="@LogicalOperator"
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                        Auto="false"
                                        ContainsText="Contiene"
                                        StartsWithText="Comienza con"
                                        EndsWithText="Termina con"
                                        EqualsText="Igual a"
                                        NotEqualsText="Diferente de"
                                        LessThanText="Menor que"
                                        DoesNotContainText="No Contiene"
                                        GreaterThanText="Mayor que"
                                        IsNullText="Es nulo"
                                        AddFilterGroupText="Agregar Grupo de Filtro"
                                        IsNotNullText="No es nulo"
                                        IsEmptyText="Est치 vac칤o"
                                        IsNotEmptyText="No est치 vac칤o"
                                        AndOperatorText="Y"
                                        OrOperatorText="O"
                                        AddFilterText="Agregar filtro"
                                        LessThanOrEqualsText="Menor o Igual"
                                        GreaterThanOrEqualsText="Mayor o Igual"
                                        RemoveFilterText="Quitar filtro"
                                        ClearFilterText="Limpiar filtro">
                            <Properties>
                                @foreach (var field in EntityFields.Where(f => f.IsSearchable && !IsSystemField(f.PropertyName)))
                                {
                                    <CustomDataFilterProperty Property="@field.PropertyName"
                                                            Title="@GetImprovedDisplayName(field)"
                                                            Type="@field.PropertyType" />
                                }
                            </Properties>
                        </CustomDataFilter>
                        </div>

                        <!-- Botones de Acci칩n -->
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.Center">
                            <RadzenButton Text="Ejecutar Consulta"
                                        Icon="play_arrow"
                                        ButtonStyle="ButtonStyle.Primary"
                                        Size="ButtonSize.Medium"
                                        Click="@OnExecuteQueryClick"
                                        @onmouseenter="@RefreshFilterState"
                                        Disabled="@(IsLoading || !HasFilters)" />

                            <RadzenButton Text="Limpiar Filtros"
                                        Icon="clear"
                                        ButtonStyle="ButtonStyle.Light"
                                        Size="ButtonSize.Medium"
                                        Click="@OnClearFiltersClick" />
                        </RadzenStack>
                    }
                    <!-- End of IsReadOnly conditional -->
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
}

@code {
    [Parameter] public string? SelectedEntityName { get; set; }
    [Parameter] public List<EntityFieldDefinition> EntityFields { get; set; } = new();
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;

    private CustomDataFilter<object>? dataFilterRef;
    private bool hasFilters = false;
    private Timer? filterCheckTimer;

    /// <summary>
    /// Expone la referencia del DataFilter para uso del componente padre
    /// </summary>
    public CustomDataFilter<object>? DataFilter => dataFilterRef;

    /// <summary>
    /// Indica si hay filtros configurados
    /// </summary>
    private bool HasFilters => hasFilters;

    [Parameter] public Frontend.Components.CustomRadzen.QueryBuilder.Models.LogicalFilterOperator LogicalOperator { get; set; } = Frontend.Components.CustomRadzen.QueryBuilder.Models.LogicalFilterOperator.And;
    [Parameter] public int TakeLimit { get; set; } = 50;

    [Parameter] public EventCallback<Frontend.Components.CustomRadzen.QueryBuilder.Models.LogicalFilterOperator> LogicalOperatorChanged { get; set; }
    [Parameter] public EventCallback<int> TakeLimitChanged { get; set; }

    [Parameter] public EventCallback OnExecuteQuery { get; set; }
    [Parameter] public EventCallback OnClearFilters { get; set; }
    [Parameter] public EventCallback OnDataFilterReady { get; set; }
    
    // Read-only mode parameters
    [Parameter] public List<Frontend.Pages.AdvancedQuery.SerializableFilter>? ReadOnlyFilters { get; set; }

    private async Task OnExecuteQueryClick()
    {
        // Verificar estado antes de ejecutar
        RefreshFilterState();
        await OnExecuteQuery.InvokeAsync();
    }

    private async Task OnClearFiltersClick()
    {
        await OnClearFilters.InvokeAsync();
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Iniciar timer para verificar cambios en filtros cada 500ms
            filterCheckTimer = new Timer(CheckFiltersState, null, 500, 500);
            
            // Notificar cuando DataFilter est칠 listo
            if (dataFilterRef != null)
            {
                Console.WriteLine("游꿢 FilterConfiguration: DataFilter is ready on first render");
                await OnDataFilterReady.InvokeAsync();
            }
            else
            {
                Console.WriteLine("丘멆잺 FilterConfiguration: DataFilter is null on first render");
                // Intentar notificar despu칠s de un peque침o delay
                _ = Task.Run(async () =>
                {
                    await Task.Delay(100);
                    await InvokeAsync(async () =>
                    {
                        if (dataFilterRef != null)
                        {
                            Console.WriteLine("游꿢 FilterConfiguration: DataFilter ready after delay");
                            await OnDataFilterReady.InvokeAsync();
                        }
                    });
                });
            }
        }
    }

    private void CheckFiltersState(object? state)
    {
        try
        {
            var currentHasFilters = dataFilterRef?.Filters?.Any() == true;
            if (currentHasFilters != hasFilters)
            {
                hasFilters = currentHasFilters;
                InvokeAsync(StateHasChanged);
            }
        }
        catch
        {
            // Ignorar errores del timer
        }
    }

    /// <summary>
    /// M칠todo p칰blico para refrescar el estado de los filtros desde el componente padre
    /// </summary>
    public void RefreshFilterState()
    {
        hasFilters = dataFilterRef?.Filters?.Any() == true;
        StateHasChanged();
    }

    /// <summary>
    /// Determina si un campo es un campo del sistema que debe ser excluido de los filtros
    /// </summary>
    private bool IsSystemField(string propertyName)
    {
        var systemFields = new[] { "OrganizationId", "CreadorId", "ModificadorId", "Active" };
        return systemFields.Contains(propertyName, StringComparer.OrdinalIgnoreCase);
    }
    
    /// <summary>
    /// Verifica si hay filtros configurados (para modo read-only)
    /// </summary>
    private bool HasConfiguredFilters()
    {
        if (IsReadOnly)
        {
            return ReadOnlyFilters?.Any() == true;
        }
        return HasFilters;
    }
    
    /// <summary>
    /// Obtiene el texto descriptivo del operador l칩gico
    /// </summary>
    private string GetLogicalOperatorText()
    {
        return LogicalOperator switch
        {
            Frontend.Components.CustomRadzen.QueryBuilder.Models.LogicalFilterOperator.And => "Y (AND)",
            Frontend.Components.CustomRadzen.QueryBuilder.Models.LogicalFilterOperator.Or => "O (OR)",
            _ => "Desconocido"
        };
    }
    
    /// <summary>
    /// Obtiene el texto descriptivo del operador de filtro
    /// </summary>
    private string GetOperatorText(string operatorValue)
    {
        return operatorValue switch
        {
            "Equal" => "Igual a",
            "NotEqual" => "Diferente de",
            "LessThan" => "Menor que",
            "LessThanOrEqual" => "Menor o igual",
            "GreaterThan" => "Mayor que",
            "GreaterThanOrEqual" => "Mayor o igual",
            "StartsWith" => "Comienza con",
            "EndsWith" => "Termina con",
            "Contains" => "Contiene",
            "DoesNotContain" => "No contiene",
            "IsNull" => "Es nulo",
            "IsNotNull" => "No es nulo",
            "IsEmpty" => "Est치 vac칤o",
            "IsNotEmpty" => "No est치 vac칤o",
            _ => operatorValue
        };
    }

    /// <summary>
    /// Obtiene el nombre mejorado para mostrar en el filtro
    /// Convierte "RegionId" a "Region" para campos de relaci칩n
    /// </summary>
    private string GetImprovedDisplayName(dynamic field)
    {
        var propertyName = field.PropertyName;
        var displayName = field.DisplayName;

        // Si el campo es una relaci칩n Guid (como RegionId -> Region)
        if (!string.IsNullOrEmpty(propertyName) && propertyName.EndsWith("Id", StringComparison.OrdinalIgnoreCase))
        {
            // Buscar si existe una propiedad de navegaci칩n correspondiente
            var navigationPropertyName = propertyName.Substring(0, propertyName.Length - 2);

            // Buscar en EntityFields si existe la propiedad de navegaci칩n
            var hasNavigationProperty = EntityFields.Any(f => f.PropertyName.Equals(navigationPropertyName, StringComparison.OrdinalIgnoreCase));

            if (hasNavigationProperty || IsLikelyNavigationProperty(propertyName))
            {
                return navigationPropertyName;
            }
        }

        // Si no es una relaci칩n, devolver el DisplayName original
        return displayName;
    }

    /// <summary>
    /// Determina si un campo es probablemente una propiedad de navegaci칩n
    /// basado en patrones comunes como RegionId, CreadorId, etc.
    /// </summary>
    private bool IsLikelyNavigationProperty(string propertyName)
    {
        if (string.IsNullOrEmpty(propertyName) || !propertyName.EndsWith("Id", StringComparison.OrdinalIgnoreCase))
            return false;

        // Lista de patrones comunes de relaciones
        var commonRelationPatterns = new[]
        {
            "RegionId", "CreadorId", "ModificadorId", "OrganizationId", "UserId", "RoleId",
            "CategoryId", "StatusId", "TypeId", "StateId", "CountryId", "CityId"
        };

        return commonRelationPatterns.Any(pattern => propertyName.Equals(pattern, StringComparison.OrdinalIgnoreCase));
    }

    public void Dispose()
    {
        filterCheckTimer?.Dispose();
    }
}