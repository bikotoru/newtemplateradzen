@using Radzen.Blazor
@implements IDisposable

@if (!string.IsNullOrEmpty(SelectedEntityName) && EntityFields.Any())
{
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenStack Gap="1rem">
                    <RadzenText TextStyle="TextStyle.H6">2. Configurar Filtros</RadzenText>

                    <!-- Configuración Global del Filtro -->
                    <RadzenRow>
                        <RadzenColumn Size="6">
                            <RadzenLabel Text="Operador Lógico Principal:" />
                            <RadzenSelectBar @bind-Value="LogicalOperator" TValue="LogicalFilterOperator">
                                <Items>
                                    <RadzenSelectBarItem Text="Y (AND)" Value="LogicalFilterOperator.And" />
                                    <RadzenSelectBarItem Text="O (OR)" Value="LogicalFilterOperator.Or" />
                                </Items>
                            </RadzenSelectBar>
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenLabel Text="Límite de Resultados:" />
                            <RadzenNumeric @bind-Value="TakeLimit" Min="1" Max="1000" Style="width: 100%;" />
                        </RadzenColumn>
                    </RadzenRow>

                    <!-- RadzenDataFilter -->
                    <div @onclick="@RefreshFilterState" @onclick:stopPropagation="false">
                        <RadzenDataFilter @ref="dataFilterRef"
                                        TItem="object"
                                        LogicalFilterOperator="@LogicalOperator"
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                        Auto="false"
                                        ContainsText="Contiene"
                                        StartsWithText="Comienza con"
                                        EndsWithText="Termina con"
                                        EqualsText="Igual a"
                                        NotEqualsText="Diferente de"
                                        LessThanText="Menor que"
                                        DoesNotContainText="No Contiene"
                                        GreaterThanText="Mayor que"
                                        IsNullText="Es nulo"
                                        AddFilterGroupText="Agregar Grupo de Filtro"
                                        IsNotNullText="No es nulo"
                                        IsEmptyText="Está vacío"
                                        IsNotEmptyText="No está vacío"
                                        AndOperatorText="Y"
                                        OrOperatorText="O"
                                        AddFilterText="Agregar filtro"
                                        LessThanOrEqualsText="Menor o Igual"
                                        GreaterThanOrEqualsText="Mayor o Igual"
                                        RemoveFilterText="Quitar filtro"
                                        ClearFilterText="Limpiar filtro">
                            <Properties>
                                @foreach (var field in EntityFields.Where(f => f.IsSearchable && !IsSystemField(f.PropertyName)))
                                {
                                    <RadzenDataFilterProperty Property="@field.PropertyName"
                                                            Title="@field.DisplayName"
                                                            Type="@field.PropertyType" />
                                }
                            </Properties>
                        </RadzenDataFilter>
                    </div>

                    <!-- Botones de Acción -->
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.Center">
                        <RadzenButton Text="Ejecutar Consulta"
                                    Icon="play_arrow"
                                    ButtonStyle="ButtonStyle.Primary"
                                    Size="ButtonSize.Medium"
                                    Click="@OnExecuteQueryClick"
                                    @onmouseenter="@RefreshFilterState"
                                    Disabled="@(IsLoading || !HasFilters)" />

                        <RadzenButton Text="Limpiar Filtros"
                                    Icon="clear"
                                    ButtonStyle="ButtonStyle.Light"
                                    Size="ButtonSize.Medium"
                                    Click="@OnClearFiltersClick" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
}

@code {
    [Parameter] public string? SelectedEntityName { get; set; }
    [Parameter] public List<EntityFieldDefinition> EntityFields { get; set; } = new();
    [Parameter] public bool IsLoading { get; set; }

    private RadzenDataFilter<object>? dataFilterRef;
    private bool hasFilters = false;
    private Timer? filterCheckTimer;

    /// <summary>
    /// Expone la referencia del DataFilter para uso del componente padre
    /// </summary>
    public RadzenDataFilter<object>? DataFilter => dataFilterRef;

    /// <summary>
    /// Indica si hay filtros configurados
    /// </summary>
    private bool HasFilters => hasFilters;

    [Parameter] public LogicalFilterOperator LogicalOperator { get; set; } = LogicalFilterOperator.And;
    [Parameter] public int TakeLimit { get; set; } = 50;

    [Parameter] public EventCallback<LogicalFilterOperator> LogicalOperatorChanged { get; set; }
    [Parameter] public EventCallback<int> TakeLimitChanged { get; set; }

    [Parameter] public EventCallback OnExecuteQuery { get; set; }
    [Parameter] public EventCallback OnClearFilters { get; set; }

    private async Task OnExecuteQueryClick()
    {
        // Verificar estado antes de ejecutar
        RefreshFilterState();
        await OnExecuteQuery.InvokeAsync();
    }

    private async Task OnClearFiltersClick()
    {
        await OnClearFilters.InvokeAsync();
    }


    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            // Iniciar timer para verificar cambios en filtros cada 500ms
            filterCheckTimer = new Timer(CheckFiltersState, null, 500, 500);
        }
    }

    private void CheckFiltersState(object? state)
    {
        try
        {
            var currentHasFilters = dataFilterRef?.Filters?.Any() == true;
            if (currentHasFilters != hasFilters)
            {
                hasFilters = currentHasFilters;
                InvokeAsync(StateHasChanged);
            }
        }
        catch
        {
            // Ignorar errores del timer
        }
    }

    /// <summary>
    /// Método público para refrescar el estado de los filtros desde el componente padre
    /// </summary>
    public void RefreshFilterState()
    {
        hasFilters = dataFilterRef?.Filters?.Any() == true;
        StateHasChanged();
    }

    /// <summary>
    /// Determina si un campo es un campo del sistema que debe ser excluido de los filtros
    /// </summary>
    private bool IsSystemField(string propertyName)
    {
        var systemFields = new[] { "OrganizationId", "CreadorId", "ModificadorId", "Active" };
        return systemFields.Contains(propertyName, StringComparer.OrdinalIgnoreCase);
    }

    public void Dispose()
    {
        filterCheckTimer?.Dispose();
    }
}