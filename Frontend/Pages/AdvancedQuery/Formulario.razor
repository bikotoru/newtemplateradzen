@page "/advanced-query/saved-queries/formulario"
@page "/advanced-query/saved-queries/formulario/{Id:guid}"
@using Frontend.Components.Base.Forms.PageWithCommandBar
@using Frontend.Components.Base
@using Frontend.Components.Validation
@using Frontend.Components.Forms
@using Frontend.Pages.AdvancedQuery
@inherits AuthorizedPageBase
@attribute [AuthorizePermission("SAVEDQUERIES.VIEW", "SAVEDQUERIES.CREATE")]

<PageTitle>@(isEditMode ? $"Editar Búsqueda Guardada - {entity?.Name}" : "Nueva Búsqueda Guardada")</PageTitle>

@if (HasRequiredPermissions && !IsCheckingPermissions)
{
    <PageWithCommandBar BackPath="/advanced-query/saved-queries/list" 
                        ShowSave="@CanSave"
                        OnSaveClick="@SaveForm">

        <div class="full-width-tabs">
            <CrmTabs DefaultTabId="tab1" DisableUrlSync="true">
                
                <CrmTab Id="tab1" Title="Información General" Icon="edit" IconColor="#0078d4">
                    <div class="scrollable-content">
                        <RadzenRow JustifyContent="JustifyContent.Center">
                            <RadzenColumn SizeLG="6" SizeMD="8" SizeSM="12">
                                
                                <EssentialsCard Title="@(isEditMode ? "Editar Búsqueda Guardada" : "Nueva Búsqueda Guardada")" 
                                               Icon="@(isEditMode ? "edit" : "add")" 
                                               IconColor="#0078d4"
                                               ShowEssentials=@(entity?.Id != Guid.Empty)>
                                 
                                    <EssentialsTemplate>
                                        <EssentialsGrid>
                                            <EssentialsItem Label="Puede Editar" Value="@(entity?.CanEdit == true ? "Sí" : "No")" />
                                            <EssentialsItem Label="Puede Compartir" Value="@(entity?.CanShare == true ? "Sí" : "No")" />
                                            <EssentialsItem Label="Veces Compartida" Value="@(entity?.SharedCount.ToString() ?? "0")" />
                                            <EssentialsItem Label="Creado" Value="@(entity?.FechaCreacion.ToString("dd/MM/yyyy") ?? "")" />
                                            <EssentialsItem Label="ID" Value="@(entity?.Id.ToString() ?? "")" />
                                        </EssentialsGrid>
                                    </EssentialsTemplate>
                                    
                                    <ChildContent>
                                        @if (isLoading)
                                        {
                                            <div class="loading-container" style="text-align: center; padding: 2rem;">
                                                <RadzenProgressBar ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" />
                                                <p style="margin-top: 1rem; color: #666;">Cargando datos...</p>
                                            </div>
                                        }
                                        else if (entity != null)
                                        {
                                            <FormValidator Entity="entity" Rules="@GetValidationRules()">
                                                
                                                <RadzenStack Gap="1rem">
                                                    
                                                    <!-- Nombre -->
                                                    <ValidatedInput FieldName="Name" Value="@entity.Name">
                                                        <RadzenFormField Text="Nombre *" Style="width: 100%">
                                                            <RadzenTextBox @oninput="@(v => entity.Name = v.Value?.ToString())" 
                                                                           Value="@entity.Name"
                                                                           Placeholder="Ingrese el nombre de la búsqueda" 
                                                                           Disabled="@(!CanEdit)" />
                                                        </RadzenFormField>
                                                    </ValidatedInput>

                                                    <!-- Descripción -->
                                                    <ValidatedInput FieldName="Description" Value="@entity.Description">
                                                        <RadzenFormField Text="Descripción" Style="width: 100%">
                                                            <RadzenTextArea @oninput="@(v => entity.Description = v.Value?.ToString())" 
                                                                           Value="@entity.Description"
                                                                           Placeholder="Descripción opcional de la búsqueda"
                                                                           Rows="3"
                                                                           Disabled="@(!CanEdit)" />
                                                        </RadzenFormField>
                                                    </ValidatedInput>

                                                    <!-- Entidad -->
                                                    <ValidatedInput FieldName="EntityName" Value="@entity.EntityName">
                                                        <RadzenFormField Text="Entidad *" Style="width: 100%">
                                                            <RadzenDropDown @bind-Value="@entity.EntityName"
                                                                           Data="@availableEntities"
                                                                           TextProperty="Name"
                                                                           ValueProperty="Name"
                                                                           Placeholder="Selecciona una entidad"
                                                                           Disabled="@(!CanEdit || isEditMode)" />
                                                        </RadzenFormField>
                                                    </ValidatedInput>

                                                    <!-- Límite de registros -->
                                                    <ValidatedInput FieldName="TakeLimit" Value="@entity.TakeLimit">
                                                        <RadzenFormField Text="Límite de Registros *" Style="width: 100%">
                                                            <RadzenNumeric @bind-Value="@entity.TakeLimit"
                                                                          Min="1"
                                                                          Max="10000"
                                                                          TValue="int"
                                                                          Disabled="@(!CanEdit)" />
                                                        </RadzenFormField>
                                                    </ValidatedInput>

                                                    <!-- Operador Lógico -->
                                                    <ValidatedInput FieldName="LogicalOperator" Value="@entity.LogicalOperator">
                                                        <RadzenFormField Text="Operador Lógico" Style="width: 100%">
                                                            <RadzenDropDown @bind-Value="@entity.LogicalOperator"
                                                                           Data="@logicalOperators"
                                                                           TextProperty="Text"
                                                                           ValueProperty="Value"
                                                                           Disabled="@(!CanEdit)" />
                                                        </RadzenFormField>
                                                    </ValidatedInput>

                                                    <!-- Opciones -->
                                                    <RadzenFieldset Text="Opciones">
                                                        <RadzenStack Gap="0.5rem">
                                                            <RadzenCheckBox @bind-Value="@entity.IsPublic" 
                                                                           TValue="bool" 
                                                                           Name="IsPublic"
                                                                           Disabled="@(!CanEdit)" />
                                                            <RadzenLabel Text="Búsqueda Pública" For="IsPublic" />
                                                            
                                                            <RadzenCheckBox @bind-Value="@entity.IsTemplate" 
                                                                           TValue="bool" 
                                                                           Name="IsTemplate"
                                                                           Disabled="@(!CanEdit)" />
                                                            <RadzenLabel Text="Usar como Plantilla" For="IsTemplate" />
                                                        </RadzenStack>
                                                    </RadzenFieldset>
                                                    
                                                </RadzenStack>
                                                
                                            </FormValidator>
                                        }
                                    </ChildContent>
                                </EssentialsCard>
                                
                            </RadzenColumn>
                        </RadzenRow>
                    </div>
                </CrmTab>

                @if (isEditMode && entity != null)
                {
                    <CrmTab Id="tab2" Title="Configuración de Campos" Icon="view_column" IconColor="#6B46C1">
                        <div class="scrollable-content" style="padding: 1rem;">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.H6">Campos Seleccionados</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin-bottom: 1rem;">
                                    Los campos seleccionados para mostrar en los resultados de la búsqueda.
                                </RadzenText>
                                
                                @if (!string.IsNullOrEmpty(entity.SelectedFields))
                                {
                                    <RadzenTextArea Value="@entity.SelectedFields" 
                                                   Rows="8" 
                                                   Style="width: 100%; font-family: monospace;"
                                                   ReadOnly="true" />
                                }
                                else
                                {
                                    <RadzenAlert AlertStyle="AlertStyle.Info">
                                        No hay campos seleccionados. Esta búsqueda mostrará todos los campos disponibles.
                                    </RadzenAlert>
                                }
                            </RadzenCard>
                        </div>
                    </CrmTab>

                    <CrmTab Id="tab3" Title="Filtros" Icon="filter_list" IconColor="#FF6B35">
                        <div class="scrollable-content" style="padding: 1rem;">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.H6">Configuración de Filtros</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin-bottom: 1rem;">
                                    Los filtros aplicados a esta búsqueda guardada.
                                </RadzenText>
                                
                                @if (!string.IsNullOrEmpty(entity.FilterConfiguration))
                                {
                                    <RadzenTextArea Value="@entity.FilterConfiguration" 
                                                   Rows="10" 
                                                   Style="width: 100%; font-family: monospace;"
                                                   ReadOnly="true" />
                                }
                                else
                                {
                                    <RadzenAlert AlertStyle="AlertStyle.Info">
                                        No hay filtros configurados. Esta búsqueda mostrará todos los registros disponibles.
                                    </RadzenAlert>
                                }
                            </RadzenCard>
                        </div>
                    </CrmTab>

                    @if (entity.CanShare)
                    {
                        <CrmTab Id="tab4" Title="Compartir" Icon="share" IconColor="#28A745">
                            <div class="scrollable-content" style="padding: 1rem;">
                                <ShareManagementTab SavedQueryId="@entity.Id" />
                            </div>
                        </CrmTab>
                    }
                }

            </CrmTabs>
        </div>

    </PageWithCommandBar>

    @if (!CanEdit)
    {
        <div class="read-only-notice">
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                <RadzenIcon Icon="visibility" /> Estás viendo este registro en modo solo lectura. 
                @if (isEditMode)
                {
                    <text>Necesitas permisos de edición para modificarlo.</text>
                }
                else
                {
                    <text>Necesitas el permiso "SAVEDQUERIES.CREATE" para crear registros.</text>
                }
            </RadzenAlert>
        </div>
    }
}