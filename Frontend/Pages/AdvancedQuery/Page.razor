@page "/advanced-query"
@using Radzen.Blazor
@using System.Text.Json
@using Frontend.Pages.AdvancedQuery.Components
@using Frontend.Components.Base.Forms.PageWithCommandBar

<PageTitle>Consulta Avanzada</PageTitle>

<PageWithCommandBar BackPath="/"
                     ShowSave="@CanSave"
                     OnSaveClick="@SaveForm">
    <RadzenStack Gap="1rem">
        <!-- Header Section -->
        <HeaderSection />

        <!-- Entity Selector -->
        <EntitySelector AvailableEntities="@availableEntities"
                       @bind-SelectedEntityName="@selectedEntityName"
                       SelectedEntity="@selectedEntity"
                       EntityFields="@entityFields"
                       SelectedFields="@selectedFields"
                       OnEntitySelectionChanged="@OnEntitySelected"
                       OnConfigureFields="@OpenFieldSelectionDialog" />

        <!-- Filter Configuration -->
        <FilterConfiguration @ref="filterConfigurationRef"
                            SelectedEntityName="@selectedEntityName"
                            EntityFields="@entityFields"
                            IsLoading="@isLoading"
                            @bind-LogicalOperator="@logicalOperator"
                            @bind-TakeLimit="@takeLimit"
                            OnExecuteQuery="@ExecuteQuery"
                            OnClearFilters="@ClearFilters" />

        <!-- Query Results -->
        <QueryResults Results="@queryResults"
                      DisplayFields="@GetDisplayFields()"
                      EntityName="@selectedEntityName"
                      LastQueryRequest="@lastExecutedRequest"
                      BackendApi="@selectedEntity?.BackendApi"
                      OnViewDetails="@ViewDetails" />

        <!-- Loading Indicator -->
        <LoadingIndicator IsLoading="@isLoading" LoadingText="Ejecutando consulta..." />
    </RadzenStack>
</PageWithCommandBar>